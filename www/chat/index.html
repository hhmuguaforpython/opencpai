<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCPAi - AIå®¡è®¡åŠ©æ‰‹</title>
    
    <!-- SEO -->
    <meta name="description" content="OpenCPAi AIå®¡è®¡åŠ©æ‰‹ - ä¸Šä¼ æ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆå®¡è®¡åº•ç¨¿">
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-dark': '#0a0a0a',
                        'bg-sidebar': '#171717',
                        'bg-chat': '#0a0a0a',
                        'bg-input': '#1a1a1a',
                        'accent-blue': '#3B82F6',
                        'accent-purple': '#8B5CF6',
                        'accent-green': '#10B981',
                    },
                    fontFamily: {
                        'inter': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* æ¶ˆæ¯åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* æ‰“å­—æŒ‡ç¤ºå™¨ */
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        .typing-dot { animation: bounce 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-zone {
            border: 2px dashed #333;
            transition: all 0.3s;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3B82F6;
            background: rgba(59, 130, 246, 0.05);
        }
    </style>
</head>
<body class="bg-bg-dark text-gray-100 font-inter antialiased h-screen flex">
    
    <!-- ========== SIDEBAR ========== -->
    <aside id="sidebar" class="w-64 bg-bg-sidebar border-r border-white/5 flex flex-col h-full">
        <!-- Logo -->
        <div class="p-4 border-b border-white/5">
            <a href="../" class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-accent-blue to-accent-purple flex items-center justify-center">
                    <span class="text-white font-bold">O</span>
                </div>
                <span class="text-lg font-semibold">OpenCPAi</span>
            </a>
        </div>
        
        <!-- New Chat Button -->
        <div class="p-3">
            <button id="new-chat-btn" class="w-full flex items-center gap-2 px-4 py-2.5 rounded-lg border border-white/10 hover:bg-white/5 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span class="text-sm">æ–°å¯¹è¯</span>
            </button>
        </div>
        
        <!-- Chat History -->
        <div class="flex-1 overflow-y-auto p-3">
            <div class="text-xs text-gray-500 px-2 mb-2">å†å²å¯¹è¯</div>
            <div id="chat-history" class="space-y-1">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
        </div>
        
        <!-- User Section -->
        <div class="p-3 border-t border-white/5">
            <a href="../" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/5 transition-colors text-gray-400 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                è¿”å›å®˜ç½‘
            </a>
        </div>
    </aside>
    
    <!-- ========== MAIN CHAT AREA ========== -->
    <main class="flex-1 flex flex-col h-full">
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto">
            
            <!-- Welcome Screen (åˆå§‹çŠ¶æ€) -->
            <div id="welcome-screen" class="h-full flex flex-col items-center justify-center px-4">
                <div class="max-w-2xl w-full text-center">
                    <!-- Logo -->
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-accent-blue to-accent-purple flex items-center justify-center mx-auto mb-6">
                        <span class="text-3xl">âœ¨</span>
                    </div>
                    
                    <h1 class="text-2xl font-semibold mb-2">ä½ å¥½ï¼Œæˆ‘æ˜¯ Jenny</h1>
                    <p class="text-gray-400 mb-8">OpenCPAi å®¡è®¡åŠ©æ‰‹ï¼Œå¸®ä½ è‡ªåŠ¨ç”Ÿæˆå®¡è®¡åº•ç¨¿</p>
                    
                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 gap-3 max-w-md mx-auto mb-8">
                        <button id="action-upload" class="upload-zone flex flex-col items-center gap-2 p-4 rounded-xl text-left hover:bg-white/5 transition-all">
                            <span class="text-2xl">ğŸ“¤</span>
                            <span class="text-sm font-medium">ä¸Šä¼ æ–‡ä»¶</span>
                            <span class="text-xs text-gray-500">Excel/ZIP</span>
                        </button>
                        <button id="action-demo" class="flex flex-col items-center gap-2 p-4 rounded-xl border border-white/10 text-left hover:bg-white/5 transition-all">
                            <span class="text-2xl">ğŸ¯</span>
                            <span class="text-sm font-medium">æ¼”ç¤ºæ¨¡å¼</span>
                            <span class="text-xs text-gray-500">ä½¿ç”¨ç¤ºä¾‹æ•°æ®</span>
                        </button>
                    </div>
                    
                    <!-- Suggested Prompts -->
                    <div class="flex flex-wrap justify-center gap-2">
                        <button class="suggest-prompt px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 text-sm transition-colors">
                            å¸®æˆ‘ç”Ÿæˆå®¡è®¡åº•ç¨¿
                        </button>
                        <button class="suggest-prompt px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 text-sm transition-colors">
                            å¦‚ä½•ä½¿ç”¨ï¼Ÿ
                        </button>
                        <button class="suggest-prompt px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 text-sm transition-colors">
                            æ”¯æŒä»€ä¹ˆæ ¼å¼ï¼Ÿ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Messages Container (å¯¹è¯çŠ¶æ€) -->
            <div id="messages-container" class="hidden max-w-3xl mx-auto py-8 px-4 space-y-6">
                <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
            
        </div>
        
        <!-- Input Area -->
        <div class="border-t border-white/5 p-4">
            <div class="max-w-3xl mx-auto">
                <!-- å·²ä¸Šä¼ æ–‡ä»¶é¢„è§ˆ -->
                <div id="uploaded-files" class="hidden flex flex-wrap gap-2 mb-3">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
                
                <!-- Input Box -->
                <div class="flex items-end gap-3">
                    <!-- Attach Button -->
                    <button id="attach-btn" class="p-3 rounded-xl bg-bg-input hover:bg-white/10 transition-colors" title="ä¸Šä¼ æ–‡ä»¶">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                        </svg>
                    </button>
                    
                    <!-- Text Input -->
                    <div class="flex-1 relative">
                        <textarea id="chat-input" 
                                  placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œæˆ–ä¸Šä¼ å®¡è®¡æ–‡ä»¶..." 
                                  rows="1"
                                  class="w-full bg-bg-input border border-white/10 rounded-2xl px-4 py-3 pr-12 text-sm resize-none 
                                         focus:outline-none focus:border-accent-blue/50 focus:ring-2 focus:ring-accent-blue/20
                                         placeholder-gray-500 max-h-32 overflow-y-auto"></textarea>
                        
                        <!-- Send Button -->
                        <button id="send-btn" 
                                class="absolute right-2 bottom-2 p-2 rounded-lg bg-accent-blue hover:bg-accent-blue/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Footer -->
                <p class="text-center text-xs text-gray-600 mt-3">
                    OpenCPAi å¯èƒ½ä¼šäº§ç”Ÿé”™è¯¯ï¼Œè¯·æ ¸å®é‡è¦ä¿¡æ¯
                </p>
            </div>
        </div>
    </main>
    
    <!-- Hidden File Input -->
    <input type="file" id="file-input" class="hidden" accept=".xlsx,.xls,.csv,.zip,.rar" multiple>
    
    <!-- JavaScript -->
    <script>
        // =====================================================
        // é…ç½®
        // =====================================================
        const CONFIG = {
            backendUrl: 'https://app.opencpai.com',
            pollInterval: 2000,
        };
        
        // =====================================================
        // çŠ¶æ€
        // =====================================================
        const state = {
            taskId: null,
            uploadedFiles: [],
            companyName: '',
            auditDate: '',
            isProcessing: false,
            messages: [],
        };
        
        // =====================================================
        // DOM å…ƒç´ 
        // =====================================================
        const $welcomeScreen = document.getElementById('welcome-screen');
        const $messagesContainer = document.getElementById('messages-container');
        const $chatMessages = document.getElementById('chat-messages');
        const $input = document.getElementById('chat-input');
        const $sendBtn = document.getElementById('send-btn');
        const $attachBtn = document.getElementById('attach-btn');
        const $fileInput = document.getElementById('file-input');
        const $uploadedFiles = document.getElementById('uploaded-files');
        const $actionUpload = document.getElementById('action-upload');
        const $actionDemo = document.getElementById('action-demo');
        const $newChatBtn = document.getElementById('new-chat-btn');
        
        // =====================================================
        // åˆå§‹åŒ–
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            $input.addEventListener('input', () => {
                $input.style.height = 'auto';
                $input.style.height = Math.min($input.scrollHeight, 128) + 'px';
                $sendBtn.disabled = !$input.value.trim();
            });
            
            // å‘é€æ¶ˆæ¯
            $sendBtn.addEventListener('click', handleSend);
            $input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
            
            // æ–‡ä»¶ä¸Šä¼ 
            $attachBtn.addEventListener('click', () => $fileInput.click());
            $actionUpload.addEventListener('click', () => $fileInput.click());
            $fileInput.addEventListener('change', handleFileSelect);
            
            // æ¼”ç¤ºæ¨¡å¼
            $actionDemo.addEventListener('click', startDemoMode);
            
            // æ–°å¯¹è¯
            $newChatBtn.addEventListener('click', resetChat);
            
            // å»ºè®®æé—®
            document.querySelectorAll('.suggest-prompt').forEach(btn => {
                btn.addEventListener('click', () => {
                    $input.value = btn.textContent;
                    $sendBtn.disabled = false;
                    handleSend();
                });
            });
            
            console.log('ğŸš€ OpenCPAi Chat initialized');
        });
        
        // =====================================================
        // æ ¸å¿ƒåŠŸèƒ½
        // =====================================================
        function handleSend() {
            const message = $input.value.trim();
            if (!message && state.uploadedFiles.length === 0) return;
            
            // åˆ‡æ¢åˆ°å¯¹è¯æ¨¡å¼
            showChatMode();
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            if (message) {
                addMessage(message, 'user');
                $input.value = '';
                $input.style.height = 'auto';
                $sendBtn.disabled = true;
            }
            
            // å¤„ç†æ„å›¾
            processIntent(message);
        }
        
        async function processIntent(message) {
            const msg = message.toLowerCase();
            
            // 1. å…ˆå°è¯•æå–å…¬å¸+æ—¥æœŸä¿¡æ¯ï¼ˆå³ä½¿æ¶ˆæ¯ä¸­åŒ…å«ã€Œå¼€å§‹å®¡è®¡ã€ï¼‰
            const info = extractCompanyInfo(message);
            if (info) {
                state.companyName = info.company;
                state.auditDate = info.date;
            }
            
            // 2. å¼€å§‹å®¡è®¡æ„å›¾ï¼ˆåŒ…æ‹¬ã€Œå…¬å¸å æ—¥æœŸ å¼€å§‹å®¡è®¡ã€è¿™ç§ç»„åˆè¾“å…¥ï¼‰
            if (msg.includes('å¼€å§‹') && (msg.includes('å®¡è®¡') || msg.includes('ç”Ÿæˆ'))) {
                if (state.uploadedFiles.length === 0) {
                    addMessage('è¯·å…ˆä¸Šä¼ å®¡è®¡æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ã€åºæ—¶è´¦ç­‰ï¼‰ï¼Œæˆ‘éœ€è¦è¿™äº›æ•°æ®æ¥ç”Ÿæˆåº•ç¨¿ã€‚', 'assistant');
                    return;
                }
                if (!state.companyName) {
                    addMessage('è¯·æä¾›å…¬å¸åç§°ï¼Œä¾‹å¦‚è¾“å…¥ã€Œè”ä¿¡æ™ºæ“ã€', 'assistant');
                    return;
                }
                await startAuditPipeline();
                return;
            }
            
            // 3. å¦‚æœåªæ˜¯è®¾ç½®äº†å…¬å¸ä¿¡æ¯ï¼ˆæ²¡è¯´å¼€å§‹å®¡è®¡ï¼‰
            if (info) {
                addMessage(`å·²è®°å½•ï¼š\nâ€¢ å…¬å¸ï¼š${info.company}\nâ€¢ å®¡è®¡æˆªæ­¢æ—¥ï¼š${info.date}\n\n${state.uploadedFiles.length > 0 ? 'è¯´ã€Œå¼€å§‹å®¡è®¡ã€å³å¯ç”Ÿæˆåº•ç¨¿ã€‚' : 'è¯·ä¸Šä¼ å®¡è®¡æ–‡ä»¶ã€‚'}`, 'assistant');
                return;
            }
            
            // 4. å¸®åŠ©
            if (msg.includes('å¦‚ä½•') || msg.includes('å¸®åŠ©') || msg.includes('ä½¿ç”¨')) {
                addMessage(`**ä½¿ç”¨æµç¨‹ï¼š**

1. ğŸ“¤ **ä¸Šä¼ æ–‡ä»¶** - ç‚¹å‡»å·¦ä¸‹è§’é™„ä»¶æŒ‰é’®ï¼Œä¸Šä¼ ç§‘ç›®ä½™é¢è¡¨ã€åºæ—¶è´¦ç­‰æ–‡ä»¶
2. ğŸ“ **ç¡®è®¤ä¿¡æ¯** - è¾“å…¥å…¬å¸åç§°å’Œå®¡è®¡æˆªæ­¢æ—¥ï¼Œå¦‚ã€Œè”ä¿¡æ™ºæ“ 2024-12-31ã€
3. ğŸš€ **ç”Ÿæˆåº•ç¨¿** - è¯´ã€Œå¼€å§‹å®¡è®¡ã€ï¼Œæˆ‘ä¼šè‡ªåŠ¨ç”Ÿæˆå®¡è®¡åº•ç¨¿

**æ”¯æŒçš„æ–‡ä»¶ï¼š**
- ç§‘ç›®ä½™é¢è¡¨ (.xlsx)
- åºæ—¶è´¦/æ˜ç»†è´¦ (.xlsx)
- è´¢åŠ¡æŠ¥è¡¨ (.xlsx)
- ä¸ŠæœŸå®¡è®¡æŠ¥å‘Š (.xlsx)
- å‹ç¼©åŒ… (.zip)`, 'assistant');
                return;
            }
            
            // 5. æ ¼å¼
            if (msg.includes('æ ¼å¼') || msg.includes('æ”¯æŒ')) {
                addMessage('æ”¯æŒ Excel æ–‡ä»¶ (.xlsx, .xls) å’Œå‹ç¼©åŒ… (.zip, .rar)ã€‚å»ºè®®å°†æ‰€æœ‰æ–‡ä»¶æ‰“åŒ…æˆ ZIP ä¸€æ¬¡æ€§ä¸Šä¼ ã€‚', 'assistant');
                return;
            }
            
            // 6. é»˜è®¤å›å¤
            addMessage('æˆ‘æ˜¯ Jennyï¼Œä¸“é—¨å¸®ä½ ç”Ÿæˆå®¡è®¡åº•ç¨¿ã€‚ä½ å¯ä»¥ï¼š\n\nâ€¢ ä¸Šä¼ å®¡è®¡æ–‡ä»¶ï¼ˆç‚¹å‡»é™„ä»¶æŒ‰é’®ï¼‰\nâ€¢ è¾“å…¥ã€Œå…¬å¸å æ—¥æœŸã€è®¾ç½®ä¿¡æ¯\nâ€¢ è¯´ã€Œå¼€å§‹å®¡è®¡ã€ç”Ÿæˆåº•ç¨¿', 'assistant');
        }
        
        // =====================================================
        // æ–‡ä»¶ä¸Šä¼ 
        // =====================================================
        async function handleFileSelect(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            showChatMode();
            addMessage(`æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...`, 'assistant');
            
            for (const file of files) {
                try {
                    const result = await uploadFile(file);
                    
                    if (result.task_id) {
                        state.taskId = result.task_id;
                    }
                    
                    if (result.files && result.files.length > 0) {
                        result.files.forEach(f => {
                            state.uploadedFiles.push({
                                name: f.filename,
                                category: f.category_cn || f.category,
                            });
                        });
                        addMessage(`âœ… å·²è¯†åˆ«ï¼š${result.files.map(f => f.category_cn || f.filename).join('ã€')}`, 'assistant');
                    } else {
                        state.uploadedFiles.push({ name: file.name });
                        addMessage(`âœ… å·²ä¸Šä¼ ï¼š${file.name}`, 'assistant');
                    }
                    
                    updateUploadedFilesUI();
                } catch (error) {
                    addMessage(`âŒ ä¸Šä¼ å¤±è´¥ï¼š${file.name} - ${error.message}`, 'assistant');
                }
            }
            
            // æç¤ºä¸‹ä¸€æ­¥
            if (state.uploadedFiles.length > 0) {
                addMessage(`å·²ä¸Šä¼  ${state.uploadedFiles.length} ä¸ªæ–‡ä»¶ã€‚\n\nè¯·è¾“å…¥å…¬å¸åç§°å’Œå®¡è®¡æˆªæ­¢æ—¥ï¼ˆå¦‚ã€Œè”ä¿¡æ™ºæ“ 2024-12-31ã€ï¼‰ï¼Œç„¶åè¯´ã€Œå¼€å§‹å®¡è®¡ã€ã€‚`, 'assistant');
            }
            
            $fileInput.value = '';
        }
        
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch(`${CONFIG.backendUrl}/api/upload-and-unpack`, {
                method: 'POST',
                body: formData,
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            return await response.json();
        }
        
        function updateUploadedFilesUI() {
            if (state.uploadedFiles.length === 0) {
                $uploadedFiles.classList.add('hidden');
                return;
            }
            
            $uploadedFiles.classList.remove('hidden');
            $uploadedFiles.innerHTML = state.uploadedFiles.map((f, i) => `
                <div class="flex items-center gap-2 px-3 py-1.5 bg-white/5 rounded-lg text-sm">
                    <span>ğŸ“„</span>
                    <span>${f.category || f.name}</span>
                    <button onclick="removeFile(${i})" class="text-gray-500 hover:text-white">Ã—</button>
                </div>
            `).join('');
        }
        
        window.removeFile = function(index) {
            state.uploadedFiles.splice(index, 1);
            updateUploadedFilesUI();
        };
        
        // =====================================================
        // å®¡è®¡ä»»åŠ¡
        // =====================================================
        async function startAuditPipeline() {
            if (!state.taskId) {
                addMessage('è¯·å…ˆä¸Šä¼ æ–‡ä»¶ã€‚', 'assistant');
                return;
            }
            
            if (!state.companyName) {
                addMessage('è¯·æä¾›å…¬å¸åç§°ï¼Œä¾‹å¦‚è¾“å…¥ã€Œè”ä¿¡æ™ºæ“ã€', 'assistant');
                return;
            }
            
            state.isProcessing = true;
            addMessage(`ğŸš€ æ­£åœ¨å¯åŠ¨å®¡è®¡ä»»åŠ¡...\nâ€¢ å…¬å¸ï¼š${state.companyName}\nâ€¢ æˆªæ­¢æ—¥ï¼š${state.auditDate || '2024/12/31'}`, 'assistant');
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/run-full-pipeline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: 'upload',
                        task_id: state.taskId,
                        company_name: state.companyName,
                        audit_end_date: state.auditDate || '2024/12/31',
                    }),
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }
                
                addMessage('â³ ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆå®¡è®¡åº•ç¨¿...\nè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œè¯·ç¨å€™ã€‚', 'assistant');
                pollTaskStatus();
                
            } catch (error) {
                addMessage(`âŒ å¯åŠ¨å¤±è´¥ï¼š${error.message}`, 'assistant');
                state.isProcessing = false;
            }
        }
        
        async function pollTaskStatus() {
            if (!state.taskId) return;
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/status/${state.taskId}`);
                const data = await response.json();
                
                if (data.status === 'completed') {
                    state.isProcessing = false;
                    showCompletedResult(data);
                } else if (data.status === 'failed') {
                    state.isProcessing = false;
                    addMessage(`âŒ ä»»åŠ¡å¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'assistant');
                } else {
                    // ç»§ç»­è½®è¯¢
                    setTimeout(pollTaskStatus, CONFIG.pollInterval);
                }
            } catch (error) {
                setTimeout(pollTaskStatus, CONFIG.pollInterval);
            }
        }
        
        function showCompletedResult(data) {
            const outputs = data.output_files || [];
            
            let html = `<div class="space-y-3">
                <p class="text-lg">ğŸ‰ å®¡è®¡åº•ç¨¿ç”Ÿæˆå®Œæˆï¼</p>
                <div class="grid grid-cols-2 gap-2">`;
            
            const downloadTypes = [
                { key: 'workpaper', label: 'ğŸ“Š å®¡è®¡åº•ç¨¿', color: 'blue' },
                { key: 'audit_report_pdf', label: 'ğŸ“„ å®¡è®¡æŠ¥å‘Š', color: 'purple' },
                { key: 'check_report_pdf', label: 'ğŸ“‹ æ£€æŸ¥æŠ¥å‘Š', color: 'green' },
                { key: 'balance_cleaned', label: 'ğŸ“‘ æ¸…æ´—æ•°æ®', color: 'gray' },
            ];
            
            downloadTypes.forEach(type => {
                const url = `${CONFIG.backendUrl}/api/download-pipeline-file/${state.taskId}/${type.key}`;
                html += `<a href="${url}" target="_blank" 
                           class="flex items-center gap-2 px-4 py-3 rounded-lg bg-${type.color}-500/10 hover:bg-${type.color}-500/20 transition-colors">
                    <span>${type.label}</span>
                </a>`;
            });
            
            html += `</div></div>`;
            
            addMessageHTML(html, 'assistant');
        }
        
        // =====================================================
        // æ¼”ç¤ºæ¨¡å¼
        // =====================================================
        async function startDemoMode() {
            showChatMode();
            addMessage('ğŸ¯ å·²è¿›å…¥æ¼”ç¤ºæ¨¡å¼ï¼Œä½¿ç”¨ç¤ºä¾‹å…¬å¸æ•°æ®...', 'assistant');
            
            // è®¾ç½®æ¼”ç¤ºå…¬å¸ä¿¡æ¯
            state.companyName = 'è”ä¿¡æ™ºæ“ï¼ˆæ·±åœ³ï¼‰ç§‘æŠ€æœ‰é™å…¬å¸';
            state.auditDate = '2024/12/31';
            
            try {
                // è°ƒç”¨åç«¯æ¼”ç¤º API
                addMessage('ğŸ“¤ æ­£åœ¨åŠ è½½ç¤ºä¾‹æ•°æ®...', 'assistant');
                
                const response = await fetch(`${CONFIG.backendUrl}/api/run-full-pipeline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: 'demo',  // ä½¿ç”¨æ¼”ç¤ºæ•°æ®
                        company_name: state.companyName,
                        audit_end_date: state.auditDate,
                    }),
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                state.taskId = data.task_id;
                
                addMessage(`âœ… ç¤ºä¾‹æ•°æ®å·²åŠ è½½\nâ€¢ å…¬å¸ï¼š${state.companyName}\nâ€¢ æˆªæ­¢æ—¥ï¼š${state.auditDate}\n\nâ³ æ­£åœ¨ç”Ÿæˆå®¡è®¡åº•ç¨¿...`, 'assistant');
                
                // æ¨¡æ‹Ÿä¸Šä¼ æ–‡ä»¶çŠ¶æ€
                state.uploadedFiles = [
                    { name: 'ç§‘ç›®ä½™é¢è¡¨', category: 'ç§‘ç›®ä½™é¢è¡¨' },
                    { name: 'åºæ—¶è´¦', category: 'åºæ—¶è´¦' },
                ];
                updateUploadedFilesUI();
                
                // å¼€å§‹è½®è¯¢
                pollTaskStatus();
                
            } catch (error) {
                addMessage(`âŒ æ¼”ç¤ºæ¨¡å¼å¯åŠ¨å¤±è´¥ï¼š${error.message}\n\nè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚`, 'assistant');
            }
        }
        
        // =====================================================
        // UI è¾…åŠ©
        // =====================================================
        function showChatMode() {
            $welcomeScreen.classList.add('hidden');
            $messagesContainer.classList.remove('hidden');
        }
        
        function resetChat() {
            state.taskId = null;
            state.uploadedFiles = [];
            state.companyName = '';
            state.auditDate = '';
            state.isProcessing = false;
            state.messages = [];
            
            $messagesContainer.innerHTML = '';
            $uploadedFiles.innerHTML = '';
            $uploadedFiles.classList.add('hidden');
            
            $welcomeScreen.classList.remove('hidden');
            $messagesContainer.classList.add('hidden');
        }
        
        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-fade-in flex gap-3 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            const avatar = role === 'user' 
                ? '<div class="w-8 h-8 rounded-full bg-accent-blue flex items-center justify-center text-sm">ğŸ‘¤</div>'
                : '<div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>';
            
            const bubbleClass = role === 'user'
                ? 'bg-accent-blue/20 rounded-2xl rounded-tr-sm'
                : 'bg-white/5 rounded-2xl rounded-tl-sm';
            
            // ç®€å• Markdown è½¬æ¢
            const html = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `
                ${avatar}
                <div class="max-w-xl ${bubbleClass} px-4 py-3 text-sm leading-relaxed">
                    ${html}
                </div>
            `;
            
            $messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function addMessageHTML(html, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-fade-in flex gap-3 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            messageDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>
                <div class="max-w-xl bg-white/5 rounded-2xl rounded-tl-sm px-4 py-3 text-sm leading-relaxed">
                    ${html}
                </div>
            `;
            
            $messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function scrollToBottom() {
            $chatMessages.scrollTop = $chatMessages.scrollHeight;
        }
        
        function extractCompanyInfo(message) {
            const datePatterns = [
                /(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/,
                /(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥?)/,
            ];
            
            let date = null;
            let company = message;
            
            // æå–æ—¥æœŸ
            for (const pattern of datePatterns) {
                const match = message.match(pattern);
                if (match) {
                    date = match[1].replace(/[å¹´æœˆ]/g, '-').replace(/æ—¥/g, '');
                    company = message.replace(match[0], '').trim();
                    break;
                }
            }
            
            // æ¸…é™¤å¤šä½™çš„å…³é”®è¯ï¼ˆå¼€å§‹å®¡è®¡ã€ç”Ÿæˆåº•ç¨¿ç­‰ï¼‰
            const removeKeywords = ['å¼€å§‹å®¡è®¡', 'å¼€å§‹', 'å®¡è®¡', 'ç”Ÿæˆåº•ç¨¿', 'ç”Ÿæˆ', 'å¸®æˆ‘', 'è¯·'];
            for (const kw of removeKeywords) {
                company = company.replace(new RegExp(kw, 'g'), '').trim();
            }
            
            // å¦‚æœæœ‰æ—¥æœŸï¼Œè¿”å›ç»“æœ
            if (date && company.length >= 2) {
                return { company, date };
            }
            
            // å¦‚æœæ²¡æœ‰æ—¥æœŸä½†æœ‰å…¬å¸åç‰¹å¾
            if (!date && company.length >= 2 && !company.includes('ï¼Ÿ') && !company.includes('?')) {
                const companyKeywords = ['å…¬å¸', 'æœ‰é™', 'é›†å›¢', 'ç§‘æŠ€', 'æ§è‚¡', 'äº‹åŠ¡æ‰€', 'åˆä¼™'];
                if (companyKeywords.some(k => company.includes(k))) {
                    return { company, date: '2024/12/31' };  // é»˜è®¤ä½¿ç”¨2024å¹´åº•
                }
            }
            
            return null;
        }
    </script>
</body>
</html>
