<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCPAi - æ™ºèƒ½è¾…åŠ©å®¡è®¡åŠ©æ‰‹</title>
    
    <!-- SEO -->
    <meta name="description" content="OpenCPAi æ™ºèƒ½è¾…åŠ©å®¡è®¡åŠ©æ‰‹ - ä¸Šä¼ æ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆå®¡è®¡åº•ç¨¿">
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-dark': '#0a0a0a',
                        'bg-sidebar': '#171717',
                        'bg-chat': '#0a0a0a',
                        'bg-input': '#1a1a1a',
                        'accent-blue': '#3B82F6',
                        'accent-purple': '#8B5CF6',
                        'accent-green': '#10B981',
                    },
                    fontFamily: {
                        'inter': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* æ¶ˆæ¯åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* æ‰“å­—æŒ‡ç¤ºå™¨ */
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        .typing-dot { animation: bounce 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-zone {
            border: 2px dashed #333;
            transition: all 0.3s;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3B82F6;
            background: rgba(59, 130, 246, 0.05);
        }
        
        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar {
            transition: width 0.5s ease-out;
            background: linear-gradient(90deg, #3B82F6, #8B5CF6, #10B981);
            background-size: 200% 100%;
            animation: progressShimmer 2s linear infinite;
        }
        @keyframes progressShimmer {
            0% { background-position: 100% 0; }
            100% { background-position: -100% 0; }
        }
        
        /* ç»ˆç«¯æ—¥å¿—çª—å£ */
        .log-window {
            background: #0f172a;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }
        .log-line {
            color: #94a3b8;
            line-height: 1.4;
        }
        .log-line.success { color: #10B981; }
        .log-line.info { color: #3B82F6; }
        .log-line.warning { color: #F59E0B; }
        
        /* è®¡æ—¶å™¨è„‰å†² */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .timer-pulse { animation: pulse 1s infinite; }
        
        /* æ­¥éª¤å®ŒæˆåŠ¨ç”» */
        .step-done { color: #10B981; }
        .step-running { color: #3B82F6; animation: pulse 1s infinite; }
        
        /* ç§»åŠ¨ç«¯å“åº”å¼ */
        @media (max-width: 768px) {
            /* éšè—ä¾§è¾¹æ  */
            #sidebar { display: none; }
            
            /* è°ƒæ•´æ¬¢è¿å± */
            #welcome-screen h1 { font-size: 1.5rem; }
            #welcome-screen p { font-size: 0.875rem; }
            
            /* è°ƒæ•´å¿«æ·æŒ‰é’® */
            #welcome-screen .grid-cols-2 { gap: 0.5rem; }
            #welcome-screen button { padding: 0.75rem; }
            
            /* è°ƒæ•´æ¶ˆæ¯å®¹å™¨ */
            #messages-container { padding: 1rem; }
            
            /* è°ƒæ•´è¿›åº¦å¡ç‰‡ */
            .log-window { display: none; }
            #steps-list { grid-template-columns: repeat(5, 1fr); gap: 0.25rem; font-size: 0.65rem; }
            #steps-list .w-6 { width: 1.25rem; height: 1.25rem; font-size: 0.6rem; }
            
            /* è°ƒæ•´ç»“æœå¡ç‰‡ */
            #result-card .grid-cols-2 { grid-template-columns: 1fr; }
            #result-card .flex.gap-3 { flex-direction: column; }
            
            /* è°ƒæ•´è¾“å…¥åŒº */
            #chat-input { font-size: 16px; } /* é˜²æ­¢iOSç¼©æ”¾ */
        }
        
        /* å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            #welcome-screen .flex-wrap { flex-direction: column; }
            #welcome-screen .suggest-prompt { width: 100%; }
        }
    </style>
</head>
<body class="bg-bg-dark text-gray-100 font-inter antialiased h-screen flex">
    
    <!-- ç§»åŠ¨ç«¯å¤´éƒ¨ -->
    <header id="mobile-header" class="fixed top-0 left-0 right-0 z-50 bg-bg-dark/95 backdrop-blur border-b border-white/5 p-3 md:hidden">
        <div class="flex items-center justify-between">
            <a href="../" class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-accent-blue to-accent-purple flex items-center justify-center">
                    <span class="text-white font-bold text-sm">O</span>
                </div>
                <span class="font-semibold">OpenCPAi</span>
            </a>
            <button id="mobile-new-chat" class="p-2 rounded-lg border border-white/10 hover:bg-white/5">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
            </button>
        </div>
    </header>
    
    <!-- ========== SIDEBAR ========== -->
    <aside id="sidebar" class="w-64 bg-bg-sidebar border-r border-white/5 flex-col h-full hidden md:flex">
        <!-- Logo -->
        <div class="p-4 border-b border-white/5">
            <a href="../" class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-accent-blue to-accent-purple flex items-center justify-center">
                    <span class="text-white font-bold">O</span>
                </div>
                <span class="text-lg font-semibold">OpenCPAi</span>
            </a>
        </div>
        
        <!-- New Chat Button -->
        <div class="p-3">
            <button id="new-chat-btn" class="w-full flex items-center gap-2 px-4 py-2.5 rounded-lg border border-white/10 hover:bg-white/5 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span class="text-sm">æ–°å¯¹è¯</span>
            </button>
        </div>
        
        <!-- Chat History -->
        <div class="flex-1 overflow-y-auto p-3">
            <div class="text-xs text-gray-500 px-2 mb-2">å†å²å¯¹è¯</div>
            <div id="chat-history" class="space-y-1">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
        </div>
        
        <!-- User Section -->
        <div class="p-3 border-t border-white/5">
            <a href="../" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/5 transition-colors text-gray-400 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                è¿”å›å®˜ç½‘
            </a>
        </div>
    </aside>
    
    <!-- ========== MAIN CHAT AREA ========== -->
    <main class="flex-1 flex flex-col h-full pt-14 md:pt-0">
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto">
            
            <!-- Welcome Screen (åˆå§‹çŠ¶æ€) -->
            <div id="welcome-screen" class="h-full flex flex-col items-center justify-center px-4">
                <div class="max-w-2xl w-full text-center">
                    <!-- Logo -->
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-accent-blue to-accent-purple flex items-center justify-center mx-auto mb-6">
                        <span class="text-3xl">âœ¨</span>
                    </div>
                    
                    <h1 class="text-2xl font-semibold mb-2">ä½ å¥½ï¼Œæˆ‘æ˜¯ Jenny</h1>
                    <p class="text-gray-400 mb-8">OpenCPAi æ™ºèƒ½è¾…åŠ©åŠ©æ‰‹ï¼Œä¸€é”®ç”Ÿæˆè´¢å®¡åº•ç¨¿</p>
                    
                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 gap-3 max-w-md mx-auto mb-8">
                        <button id="action-upload" class="upload-zone flex flex-col items-center gap-2 p-4 rounded-xl text-left hover:bg-white/5 transition-all">
                            <span class="text-2xl">ğŸ“¤</span>
                            <span class="text-sm font-medium">ä¸Šä¼ æ–‡ä»¶</span>
                            <span class="text-xs text-gray-500">Excel/ZIP</span>
                        </button>
                        <button id="action-demo" class="flex flex-col items-center gap-2 p-4 rounded-xl border border-white/10 text-left hover:bg-white/5 transition-all">
                            <span class="text-2xl">ğŸ¯</span>
                            <span class="text-sm font-medium">æ¼”ç¤ºæ¨¡å¼</span>
                            <span class="text-xs text-gray-500">ä½¿ç”¨ç¤ºä¾‹æ•°æ®</span>
                        </button>
                    </div>
                    
                    <!-- Suggested Prompts -->
                    <div class="flex flex-wrap justify-center gap-2">
                        <button class="suggest-prompt px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 text-sm transition-colors">
                            ğŸš€ å¯åŠ¨ OpenCPAi å¼•æ“
                        </button>
                        <button class="suggest-prompt px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 text-sm transition-colors">
                            å¦‚ä½•ä½¿ç”¨ï¼Ÿ
                        </button>
                        <button class="suggest-prompt px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 text-sm transition-colors">
                            æ”¯æŒä»€ä¹ˆæ ¼å¼ï¼Ÿ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Messages Container (å¯¹è¯çŠ¶æ€) -->
            <div id="messages-container" class="hidden max-w-3xl mx-auto py-8 px-4 space-y-6">
                <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
            
        </div>
        
        <!-- Input Area -->
        <div class="border-t border-white/5 p-4">
            <div class="max-w-3xl mx-auto">
                <!-- å·²ä¸Šä¼ æ–‡ä»¶é¢„è§ˆ -->
                <div id="uploaded-files" class="hidden flex flex-wrap gap-2 mb-3">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
                
                <!-- Input Box -->
                <div class="flex items-end gap-3">
                    <!-- Attach Button -->
                    <button id="attach-btn" class="p-3 rounded-xl bg-bg-input hover:bg-white/10 transition-colors" title="ä¸Šä¼ æ–‡ä»¶">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                        </svg>
                    </button>
                    
                    <!-- Text Input -->
                    <div class="flex-1 relative">
                        <textarea id="chat-input" 
                                  placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œæˆ–ä¸Šä¼ æ–‡ä»¶..." 
                                  rows="1"
                                  class="w-full bg-bg-input border border-white/10 rounded-2xl px-4 py-3 pr-12 text-sm resize-none 
                                         focus:outline-none focus:border-accent-blue/50 focus:ring-2 focus:ring-accent-blue/20
                                         placeholder-gray-500 max-h-32 overflow-y-auto"></textarea>
                        
                        <!-- Send Button -->
                        <button id="send-btn" 
                                class="absolute right-2 bottom-2 p-2 rounded-lg bg-accent-blue hover:bg-accent-blue/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Footer -->
                <p class="text-center text-xs text-gray-600 mt-3">
                    OpenCPAi å¯èƒ½ä¼šäº§ç”Ÿé”™è¯¯ï¼Œè¯·æ ¸å®é‡è¦ä¿¡æ¯
                </p>
            </div>
        </div>
    </main>
    
    <!-- Hidden File Input -->
    <input type="file" id="file-input" class="hidden" accept=".xlsx,.xls,.csv,.zip,.rar,.pdf" multiple>
    
    <!-- JavaScript -->
    <script>
        // =====================================================
        // é…ç½®ï¼ˆä¸ Web App ä¿æŒä¸€è‡´ï¼šå§‹ç»ˆç”¨æœ¬åœ°åç«¯ï¼‰
        // =====================================================
        const CONFIG = {
            // â­ ä¸ Web App ä¸€è‡´ï¼šå§‹ç»ˆä½¿ç”¨æœ¬åœ°åç«¯ï¼ˆç”¨æˆ·åœ¨è‡ªå·±ç”µè„‘è¿è¡Œï¼‰
            backendUrl: 'http://127.0.0.1:8100',
            pollInterval: 2000,
        };
        console.log('ğŸ”§ Backend URL:', CONFIG.backendUrl);
        
        // =====================================================
        // çŠ¶æ€
        // =====================================================
        const state = {
            taskId: null,
            uploadedFiles: [],
            companyName: '',
            auditDate: '',
            isProcessing: false,
            messages: [],
            userName: 'å®¡è®¡å¸ˆ',  // ç”¨æˆ·åï¼Œå¯ä»ç™»å½•è·å–
            startTime: null,     // ä»»åŠ¡å¼€å§‹æ—¶é—´
            timerInterval: null, // è®¡æ—¶å™¨
        };
        
        // =====================================================
        // DOM å…ƒç´ 
        // =====================================================
        const $welcomeScreen = document.getElementById('welcome-screen');
        const $messagesContainer = document.getElementById('messages-container');
        const $chatMessages = document.getElementById('chat-messages');
        const $input = document.getElementById('chat-input');
        const $sendBtn = document.getElementById('send-btn');
        const $attachBtn = document.getElementById('attach-btn');
        const $fileInput = document.getElementById('file-input');
        const $uploadedFiles = document.getElementById('uploaded-files');
        const $actionUpload = document.getElementById('action-upload');
        const $actionDemo = document.getElementById('action-demo');
        const $newChatBtn = document.getElementById('new-chat-btn');
        
        // =====================================================
        // åˆå§‹åŒ–
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            $input.addEventListener('input', () => {
                $input.style.height = 'auto';
                $input.style.height = Math.min($input.scrollHeight, 128) + 'px';
                $sendBtn.disabled = !$input.value.trim();
            });
            
            // å‘é€æ¶ˆæ¯
            $sendBtn.addEventListener('click', handleSend);
            $input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
            
            // æ–‡ä»¶ä¸Šä¼ 
            $attachBtn.addEventListener('click', () => $fileInput.click());
            $actionUpload.addEventListener('click', () => $fileInput.click());
            $fileInput.addEventListener('change', handleFileSelect);
            
            // æ¼”ç¤ºæ¨¡å¼
            $actionDemo.addEventListener('click', startDemoMode);
            
            // æ–°å¯¹è¯
            $newChatBtn.addEventListener('click', resetChat);
            
            // ç§»åŠ¨ç«¯æ–°å¯¹è¯æŒ‰é’®
            const $mobileNewChat = document.getElementById('mobile-new-chat');
            if ($mobileNewChat) {
                $mobileNewChat.addEventListener('click', resetChat);
            }
            
            // å»ºè®®æé—®
            document.querySelectorAll('.suggest-prompt').forEach(btn => {
                btn.addEventListener('click', () => {
                    $input.value = btn.textContent;
                    $sendBtn.disabled = false;
                    handleSend();
                });
            });
            
            console.log('ğŸš€ OpenCPAi Chat initialized');
        });
        
        // =====================================================
        // ç®€åŒ–æµç¨‹ï¼šä¸Šä¼ æ–‡ä»¶ â†’ ç›´æ¥å¯åŠ¨å¼•æ“ï¼ˆä¸ Web App ä¿æŒä¸€è‡´ï¼‰
        // å…¬å¸åç§°å’Œå®¡è®¡æ—¥æœŸç”±åç«¯è‡ªåŠ¨è¯†åˆ«ï¼Œæ— éœ€å‰ç«¯å¹²é¢„
        // =====================================================
        
        // ç»§ç»­ä¸Šä¼ æ›´å¤šæ–‡ä»¶
        window.addMoreFiles = function() {
            addMessage('è¯·ç»§ç»­ä¸Šä¼ æ–‡ä»¶ï¼Œå®Œæˆåç‚¹å‡»ã€Œå¯åŠ¨OpenCPAiå¼•æ“ç”Ÿæˆå®¡è®¡åº•ç¨¿ã€', 'assistant');
        };
        
        // ã€æ ¸å¿ƒã€‘ç›´æ¥å¯åŠ¨å¼•æ“ï¼ˆè·³è¿‡å…¬å¸åç§°è¯†åˆ«æµç¨‹ï¼‰
        window.startEngineDirectly = function() {
            addMessage('ğŸš€ å¯åŠ¨OpenCPAiå¼•æ“...', 'user');
            // å…¬å¸åç§°å’Œå®¡è®¡æ—¥æœŸä¼ ç©ºï¼Œç”±åç«¯è‡ªåŠ¨è¯†åˆ«
            state.companyName = '';
            state.auditDate = '';
            startAuditPipeline();
        };
        
        // ã€ä¿ç•™å…¼å®¹ã€‘ç¬¬äºŒæ­¥ï¼šè¯†åˆ«å…¬å¸ä¿¡æ¯ï¼ˆå·²åºŸå¼ƒï¼Œä½†ä¿ç•™å‡½æ•°é¿å…æŠ¥é”™ï¼‰
        window.proceedToStep2 = async function() {
            // ç›´æ¥è·³è½¬åˆ°å¯åŠ¨å¼•æ“
            window.startEngineDirectly();
        };
        
        // ã€åºŸå¼ƒä»£ç å¼€å§‹ - ä¿ç•™ç”¨äºå…¼å®¹æ—§è°ƒç”¨ã€‘
        async function _legacyProceedToStep2() {
            addMessage('âœ“ æ–‡ä»¶å·²ç¡®è®¤', 'user');
            addMessage('ğŸ” æ­£åœ¨è¯†åˆ«å…¬å¸ä¿¡æ¯...', 'assistant');
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/detect-company-name`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: state.taskId }),
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('ğŸ“‹ Detection result:', data);
                
                state.auditDate = normalizeDate(data.detected_audit_date) || '2025/12/31';
                const detectedName = data.detected_name;
                const confidence = data.confidence || 'low';
                const source = data.source || 'unknown';
                
                if (!detectedName || detectedName === 'æœªçŸ¥å…¬å¸') {
                    // æ£€æµ‹å¤±è´¥ - æ˜¾ç¤ºè¾“å…¥è¡¨å•
                    showCompanyInputForm(null, state.auditDate);
                } else if (confidence === 'high') {
                    // é«˜ç½®ä¿¡åº¦ - å…ˆéªŒè¯å·¥å•†ï¼Œå†æ˜¾ç¤ºç¡®è®¤å¡ç‰‡
                    await verifyAndShowConfirmCard(detectedName, state.auditDate, source);
                } else {
                    // ä¸­/ä½ç½®ä¿¡åº¦ - æ˜¾ç¤ºå¯ç¼–è¾‘è¡¨å•
                    showCompanyInputForm(detectedName, state.auditDate, source, confidence);
                }
                
            } catch (error) {
                console.error('Detect company error:', error);
                showCompanyInputForm(null, '2025/12/31');
            }
        };
        
        // æ—¥æœŸæ ¼å¼æ ‡å‡†åŒ–ï¼ˆæ”¯æŒå¤šç§è¾“å…¥æ ¼å¼ï¼‰
        function normalizeDate(dateStr) {
            if (!dateStr) return null;
            // å»é™¤ç©ºæ ¼
            dateStr = dateStr.trim();
            // æ”¯æŒæ ¼å¼ï¼š2025ã€20251231ã€2025-12-31ã€2025/12/31ã€2025.12.31
            if (/^\d{4}$/.test(dateStr)) {
                return dateStr + '/12/31';
            }
            if (/^\d{8}$/.test(dateStr)) {
                return dateStr.slice(0,4) + '/' + dateStr.slice(4,6) + '/' + dateStr.slice(6,8);
            }
            // æ›¿æ¢åˆ†éš”ç¬¦ä¸º /
            return dateStr.replace(/[-\.]/g, '/');
        }
        
        // å…¬å¸åç§°æ ‡å‡†åŒ–ï¼ˆå…¨è§’/åŠè§’æ‹¬å·ç»Ÿä¸€ï¼‰
        function normalizeCompanyName(name) {
            if (!name) return name;
            // å…¨è§’æ‹¬å·è½¬åŠè§’
            return name.replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')').trim();
        }
        
        // éªŒè¯å·¥å•†ä¿¡æ¯å¹¶æ˜¾ç¤ºç¡®è®¤å¡ç‰‡
        async function verifyAndShowConfirmCard(companyName, auditDate, source) {
            companyName = normalizeCompanyName(companyName);
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/bizinfo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company_name: companyName }),
                });
                
                if (response.ok) {
                    const bizData = await response.json();
                    if (bizData.success && bizData.data) {
                        // å·¥å•†éªŒè¯æˆåŠŸï¼Œæ˜¾ç¤ºç»¿è‰²ç¡®è®¤å¡ç‰‡
                        state.companyName = companyName;
                        showHighConfidenceCard(companyName, auditDate, source, true);
                        return;
                    }
                }
            } catch (error) {
                console.error('BizInfo error:', error);
            }
            
            // å·¥å•†éªŒè¯å¤±è´¥ï¼Œé™çº§ä¸ºå¯ç¼–è¾‘è¡¨å•
            showCompanyInputForm(companyName, auditDate, source, 'medium');
        }
        
        // é«˜ç½®ä¿¡åº¦ç¡®è®¤å¡ç‰‡ï¼ˆç»¿è‰²ï¼‰
        function showHighConfidenceCard(companyName, auditDate, source, bizVerified = false) {
            const sourceLabel = getSourceLabel(source);
            const verifiedBadge = bizVerified ? '<span class="text-xs bg-green-500/30 text-green-300 px-2 py-0.5 rounded-full ml-2">âœ“ å·¥å•†å·²éªŒè¯</span>' : '';
            
            const html = `
                <div class="space-y-4 p-4 rounded-xl border-2 border-green-500/50 bg-green-500/10">
                    <div class="flex items-center gap-2 text-green-400">
                        <span class="text-lg">âœ“</span>
                        <span class="font-medium">å·²ä»${sourceLabel}è¯†åˆ«å…¬å¸ä¿¡æ¯</span>
                        ${verifiedBadge}
                    </div>
                    
                    <div class="bg-white/5 rounded-lg p-4 space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">å…¬å¸åç§°</span>
                            <span class="text-white font-medium text-lg">${companyName}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">å®¡è®¡æˆªæ­¢æ—¥</span>
                            <span class="text-white font-medium">${auditDate}</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="window.proceedToStep3('${companyName.replace(/'/g, "\\'")}', '${auditDate}')" class="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-green-500 rounded-xl text-white font-medium hover:opacity-90 transition-all flex items-center justify-center gap-2">
                            <span>ğŸš€</span>
                            <span>ç¡®è®¤å¹¶å¯åŠ¨å¼•æ“</span>
                        </button>
                        <button onclick="window.showEditForm('${companyName.replace(/'/g, "\\'")}', '${auditDate}')" class="px-4 py-3 bg-white/10 rounded-xl text-gray-300 font-medium hover:bg-white/20 transition-all">
                            ä¿®æ”¹
                        </button>
                    </div>
                </div>
            `;
            addMessageHTML(html, 'assistant');
        }
        
        // å…¬å¸ä¿¡æ¯è¾“å…¥è¡¨å•ï¼ˆé»„è‰²/çº¢è‰²ï¼‰
        function showCompanyInputForm(companyName, auditDate, source = null, confidence = null) {
            const isDetected = companyName !== null;
            const borderColor = isDetected ? 'border-yellow-500/50 bg-yellow-500/10' : 'border-red-500/50 bg-red-500/10';
            const iconColor = isDetected ? 'text-yellow-400' : 'text-red-400';
            const icon = isDetected ? 'âš ï¸' : 'âŒ';
            const title = isDetected 
                ? `è¯†åˆ«ç»“æœéœ€è¦ç¡®è®¤ï¼ˆç½®ä¿¡åº¦ï¼š${confidence === 'medium' ? 'ä¸­' : 'ä½'}ï¼‰`
                : 'æœªèƒ½è‡ªåŠ¨è¯†åˆ«å…¬å¸ä¿¡æ¯';
            const sourceInfo = source ? `<div class="text-sm text-gray-400">æ¥æºï¼š${getSourceLabel(source)}</div>` : '';
            
            const html = `
                <div class="space-y-4 p-4 rounded-xl border-2 ${borderColor}">
                    <div class="flex items-center gap-2 ${iconColor}">
                        <span class="text-lg">${icon}</span>
                        <span class="font-medium">${title}</span>
                    </div>
                    ${sourceInfo}
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-gray-400 text-sm mb-1 block">å…¬å¸åç§° <span class="text-red-400">*</span></label>
                            <input id="input-company-name" type="text" value="${companyName || ''}" 
                                class="w-full px-4 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500 focus:outline-none transition-all"
                                placeholder="è¯·è¾“å…¥å®Œæ•´å…¬å¸åç§°ï¼Œå¦‚ï¼šæ·±åœ³è”å…´æ™ºèƒ½æœ‰é™å…¬å¸">
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm mb-1 block">å®¡è®¡æˆªæ­¢æ—¥</label>
                            <input id="input-audit-date" type="text" value="${auditDate || '2025/12/31'}" 
                                class="w-full px-4 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500 focus:outline-none transition-all"
                                placeholder="æ ¼å¼ï¼š2025/12/31 æˆ– 2025-12-31 æˆ– 20251231">
                        </div>
                    </div>
                    
                    <button onclick="window.submitCompanyInfo()" class="w-full px-4 py-3 bg-gradient-to-r from-accent-purple to-accent-blue rounded-xl text-white font-medium hover:opacity-90 transition-all flex items-center justify-center gap-2">
                        <span>ğŸš€</span>
                        <span>ç¡®è®¤å¹¶å¯åŠ¨å¼•æ“</span>
                    </button>
                </div>
            `;
            addMessageHTML(html, 'assistant');
        }
        
        // æ˜¾ç¤ºç¼–è¾‘è¡¨å•
        window.showEditForm = function(companyName, auditDate) {
            showCompanyInputForm(companyName, auditDate, 'manual', 'low');
        };
        
        // æäº¤å…¬å¸ä¿¡æ¯
        window.submitCompanyInfo = async function() {
            const companyName = normalizeCompanyName(document.getElementById('input-company-name')?.value);
            const auditDate = normalizeDate(document.getElementById('input-audit-date')?.value) || '2025/12/31';
            
            if (!companyName) {
                addMessage('âš ï¸ è¯·è¾“å…¥å…¬å¸åç§°', 'assistant');
                return;
            }
            
            // å°è¯•éªŒè¯å·¥å•†
            addMessage(`ğŸ“‹ éªŒè¯ï¼š${companyName}`, 'user');
            addMessage('ğŸ” æ­£åœ¨éªŒè¯å·¥å•†ä¿¡æ¯...', 'assistant');
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/bizinfo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company_name: companyName }),
                });
                
                if (response.ok) {
                    const bizData = await response.json();
                    if (bizData.success && bizData.data) {
                        addMessage(`âœ… å·¥å•†éªŒè¯æˆåŠŸ`, 'assistant');
                        proceedToStep3(companyName, auditDate);
                        return;
                    }
                }
                
                // å·¥å•†æœªæ‰¾åˆ°ï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­
                const html = `
                    <div class="space-y-3 p-4 rounded-xl border border-yellow-500/50 bg-yellow-500/10">
                        <div class="text-yellow-400">âš ï¸ å·¥å•†ä¿¡æ¯æœªæ‰¾åˆ°</div>
                        <div class="text-sm text-gray-400">å…¬å¸åç§°ã€Œ${companyName}ã€åœ¨å·¥å•†æ•°æ®åº“ä¸­æœªæ‰¾åˆ°ï¼Œå¯èƒ½åç§°ä¸å®Œæ•´æˆ–æœ‰è¯¯ã€‚</div>
                        <div class="flex gap-3">
                            <button onclick="window.proceedToStep3('${companyName.replace(/'/g, "\\'")}', '${auditDate}')" class="flex-1 px-4 py-2 bg-yellow-600 rounded-lg text-white font-medium hover:opacity-90">
                                ä»ç„¶ç»§ç»­
                            </button>
                            <button onclick="window.showEditForm('${companyName.replace(/'/g, "\\'")}', '${auditDate}')" class="px-4 py-2 bg-white/10 rounded-lg text-gray-300 hover:bg-white/20">
                                é‡æ–°è¾“å…¥
                            </button>
                        </div>
                    </div>
                `;
                addMessageHTML(html, 'assistant');
                
            } catch (error) {
                console.error('BizInfo error:', error);
                // API é”™è¯¯ï¼Œç›´æ¥ç»§ç»­
                proceedToStep3(companyName, auditDate);
            }
        };
        
        // ç¬¬ä¸‰æ­¥ï¼šæ­£å¼å¯åŠ¨å¼•æ“
        window.proceedToStep3 = function(companyName, auditDate) {
            state.companyName = companyName;
            state.auditDate = auditDate;
            addMessage(`ğŸš€ å¯åŠ¨å¼•æ“ï¼š${companyName}ï¼Œ${auditDate}`, 'user');
            startAuditPipeline();
        };
        
        // è·å–æ¥æºæ ‡ç­¾
        function getSourceLabel(source) {
            const labels = {
                'pdf': 'å®¡è®¡æŠ¥å‘ŠPDF',
                'excel': 'è´¢åŠ¡æŠ¥è¡¨',
                'audit_filename': 'å®¡è®¡æŠ¥å‘Šæ–‡ä»¶å',
                'balance': 'ç§‘ç›®ä½™é¢è¡¨',
                'directory': 'æ–‡ä»¶å¤¹åç§°',
                'filename': 'æ–‡ä»¶å',
                'manual': 'æ‰‹åŠ¨è¾“å…¥',
            };
            return labels[source] || source || 'æ–‡ä»¶';
        }
        
        // ã€æ—§å‡½æ•°ä¿ç•™å…¼å®¹ã€‘
        window.startPipelineDirectly = function() {
            // å¦‚æœå·²æœ‰å…¬å¸åç§°ç›´æ¥å¯åŠ¨ï¼Œå¦åˆ™èµ°ç¬¬äºŒæ­¥
            if (state.companyName) {
                proceedToStep3(state.companyName, state.auditDate || '2025/12/31');
            } else {
                proceedToStep2();
            }
        };
        
        window.quickConfirm = function() {
            startPipelineDirectly();
        };
        
        // ã€å…¼å®¹æ—§è°ƒç”¨ã€‘
        window.detectAndConfirmCompany = async function() {
            await proceedToStep2();
        };
        
        // =====================================================
        // æ ¸å¿ƒåŠŸèƒ½
        // =====================================================
        function handleSend() {
            const message = $input.value.trim();
            if (!message && state.uploadedFiles.length === 0) return;
            
            // åˆ‡æ¢åˆ°å¯¹è¯æ¨¡å¼
            showChatMode();
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            if (message) {
                addMessage(message, 'user');
                $input.value = '';
                $input.style.height = 'auto';
                $sendBtn.disabled = true;
            }
            
            // å¤„ç†æ„å›¾ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼Œæé€Ÿï¼‰
            processIntentFast(message);
        }
        
        // å¿«é€Ÿæœ¬åœ°æ„å›¾å¤„ç†ï¼šå¸¸è§æ“ä½œä¸è°ƒç”¨ LLMï¼Œç«‹å³å“åº”
        function processIntentFast(message) {
            const msg = message.toLowerCase();
            
            // 1. ç¡®è®¤ç”Ÿæˆ/å¯åŠ¨å¼•æ“ - æœ€å¸¸è§æ“ä½œï¼Œç›´æ¥å¯åŠ¨ï¼ˆä¸ Web App ä¸€è‡´ï¼‰
            if ((msg.includes('ç¡®è®¤') && msg.includes('ç”Ÿæˆ')) || 
                (msg.includes('å¯åŠ¨') && msg.includes('å¼•æ“')) || 
                (msg.includes('å¼€å§‹') && msg.includes('ç”Ÿæˆ')) ||
                msg === 'ç¡®è®¤' || msg === 'ç”Ÿæˆ') {
                if (state.uploadedFiles.length === 0) {
                    addMessage('è¯·å…ˆä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ã€åºæ—¶è´¦ç­‰ï¼‰ã€‚', 'assistant');
                    return;
                }
                // ç›´æ¥å¯åŠ¨ï¼Œå…¬å¸åç§°ç”±åç«¯è‡ªåŠ¨è¯†åˆ«
                startPipelineDirectly();
                return;
            }
            
            // 2. å¸®åŠ© - ç›´æ¥æœ¬åœ°å“åº”
            if (msg.includes('å¦‚ä½•') || msg.includes('å¸®åŠ©') || msg.includes('ä½¿ç”¨') || msg === '?' || msg === 'ï¼Ÿ') {
                addMessage(`**ä½¿ç”¨æµç¨‹ï¼š**\n\n1. ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ç­‰ï¼‰\n2. ğŸ“ ç¡®è®¤å…¬å¸åç§°å’Œæ—¥æœŸ\n3. ğŸš€ ç‚¹å‡»ã€Œç¡®è®¤ç”Ÿæˆå®¡è®¡åº•ç¨¿ã€æŒ‰é’®`, 'assistant');
                return;
            }
            
            // 3. å…¬å¸åç§°è®¾ç½® - æœ¬åœ°å¤„ç†
            const info = extractCompanyInfo(message);
            if (info) {
                state.companyName = info.company;
                state.auditDate = info.date;
                
                if (state.uploadedFiles.length > 0) {
                    // æœ‰æ–‡ä»¶ï¼Œæ˜¾ç¤ºç¡®è®¤æŒ‰é’®
                    const confirmHtml = `
                        <div class="space-y-3">
                            <div class="font-medium">ğŸ“‹ å·²æ›´æ–°ä¿¡æ¯ï¼š</div>
                            <div class="pl-2 space-y-1">
                                <div>â€¢ å…¬å¸åç§°ï¼š<strong>${state.companyName}</strong></div>
                                <div>â€¢ æˆªæ­¢æ—¥æœŸï¼š<strong>${state.auditDate}</strong></div>
                            </div>
                            <div class="pt-2">
                                <button onclick="window.quickConfirm()" class="w-full px-4 py-2.5 bg-gradient-to-r from-accent-purple to-accent-blue rounded-xl text-white font-medium hover:opacity-90 transition-all flex items-center justify-center gap-2">
                                    <span>ğŸš€</span>
                                    <span>ç¡®è®¤ç”Ÿæˆå®¡è®¡åº•ç¨¿</span>
                                </button>
                            </div>
                        </div>
                    `;
                    addMessageHTML(confirmHtml, 'assistant');
                } else {
                    addMessage(`å·²è®°å½•ï¼š\nâ€¢ å…¬å¸ï¼š${info.company}\nâ€¢ æˆªæ­¢æ—¥æœŸï¼š${info.date}\n\nè¯·ä¸Šä¼ æ–‡ä»¶åå†ç”Ÿæˆåº•ç¨¿ã€‚`, 'assistant');
                }
                return;
            }
            
            // 4. å…¶ä»–æƒ…å†µï¼šè°ƒç”¨ LLM
            processIntentWithLLM(message);
        }
        
        async function processIntentWithLLM(message) {
            // æ˜¾ç¤ºæ€è€ƒçŠ¶æ€
            showTypingIndicator();
            
            try {
                // è°ƒç”¨ LLM æ„å›¾è¯†åˆ« API
                const response = await fetch(`${CONFIG.backendUrl}/api/chat/intent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        context: {
                            uploaded_files: state.uploadedFiles.map(f => f.category || f.name),
                            company_name: state.companyName,
                            audit_date: state.auditDate,
                        }
                    }),
                });
                
                hideTypingIndicator();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('LLM Intent:', data);
                
                // æ›´æ–°çŠ¶æ€
                if (data.company_name) {
                    state.companyName = data.company_name;
                }
                if (data.audit_date) {
                    state.auditDate = data.audit_date;
                }
                
                // æ ¹æ®æ„å›¾æ‰§è¡ŒåŠ¨ä½œ
                switch (data.intent) {
                    case 'start_audit':
                        if (state.uploadedFiles.length === 0) {
                            addMessage('è¯·å…ˆä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ã€åºæ—¶è´¦ç­‰ï¼‰ï¼Œæˆ‘éœ€è¦è¿™äº›æ•°æ®æ¥ç”Ÿæˆåº•ç¨¿ã€‚', 'assistant');
                        } else if (!state.companyName) {
                            addMessage('è¯·æä¾›å…¬å¸åç§°ï¼Œä¾‹å¦‚è¾“å…¥ã€Œè”ä¿¡æ™ºæ“ã€', 'assistant');
                        } else {
                            addMessage(data.response || 'ğŸš€ æ­£åœ¨å¯åŠ¨ OpenCPAi å¼•æ“...', 'assistant');
                            await startAuditPipeline();
                        }
                        break;
                        
                    case 'upload_file':
                        addMessage(data.response || 'è¯·ç‚¹å‡»å·¦ä¸‹è§’é™„ä»¶æŒ‰é’®ä¸Šä¼ æ–‡ä»¶', 'assistant');
                        break;
                        
                    default:
                        // å…¶ä»–æ„å›¾ç›´æ¥æ˜¾ç¤º LLM å›å¤
                        addMessage(data.response, 'assistant');
                }
                
            } catch (error) {
                hideTypingIndicator();
                console.error('Intent API error:', error);
                
                // é™çº§åˆ°æœ¬åœ°å¤„ç†
                processIntentLocal(message);
            }
        }
        
        // æœ¬åœ°æ„å›¾å¤„ç†ï¼ˆLLM è°ƒç”¨å¤±è´¥æ—¶çš„é™çº§æ–¹æ¡ˆï¼‰
        function processIntentLocal(message) {
            const msg = message.toLowerCase();
            
            // æå–å…¬å¸+æ—¥æœŸä¿¡æ¯
            const info = extractCompanyInfo(message);
            if (info) {
                state.companyName = info.company;
                state.auditDate = info.date;
            }
            
            // ç¡®è®¤ç”Ÿæˆ/å¯åŠ¨å¼•æ“æ„å›¾ - ç›´æ¥å¯åŠ¨ï¼ˆä¸ Web App ä¸€è‡´ï¼‰
            if ((msg.includes('ç¡®è®¤') && msg.includes('ç”Ÿæˆ')) || (msg.includes('å¯åŠ¨') && msg.includes('å¼•æ“')) || (msg.includes('å¼€å§‹') && msg.includes('ç”Ÿæˆ'))) {
                if (state.uploadedFiles.length === 0) {
                    addMessage('è¯·å…ˆä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ã€åºæ—¶è´¦ç­‰ï¼‰ï¼Œæˆ‘éœ€è¦è¿™äº›æ•°æ®æ¥ç”Ÿæˆåº•ç¨¿ã€‚', 'assistant');
                    return;
                }
                // ç›´æ¥å¯åŠ¨ï¼Œå…¬å¸åç§°ç”±åç«¯è‡ªåŠ¨è¯†åˆ«
                startPipelineDirectly();
                return;
            }
            
            // è®¾ç½®å…¬å¸ä¿¡æ¯
            if (info) {
                if (state.uploadedFiles.length > 0) {
                    // æœ‰æ–‡ä»¶ï¼Œæç¤ºå¯ä»¥å¯åŠ¨
                    addMessage(`å·²è®°å½•ï¼š\nâ€¢ å…¬å¸ï¼š${info.company}\nâ€¢ æˆªæ­¢æ—¥æœŸï¼š${info.date}\n\nç‚¹å‡»ã€Œå¯åŠ¨å¼•æ“ã€æŒ‰é’®å¼€å§‹ç”Ÿæˆåº•ç¨¿ã€‚`, 'assistant');
                } else {
                    addMessage(`å·²è®°å½•ï¼š\nâ€¢ å…¬å¸ï¼š${info.company}\nâ€¢ æˆªæ­¢æ—¥æœŸï¼š${info.date}\n\nè¯·ä¸Šä¼ æ–‡ä»¶åå†ç”Ÿæˆåº•ç¨¿ã€‚`, 'assistant');
                }
                return;
            }
            
            // å¸®åŠ©
            if (msg.includes('å¦‚ä½•') || msg.includes('å¸®åŠ©') || msg.includes('ä½¿ç”¨')) {
                addMessage(`**ä½¿ç”¨æµç¨‹ï¼š**\n\n1. ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ç­‰ï¼‰\n2. ğŸ“ ç¡®è®¤å…¬å¸åç§°å’Œæ—¥æœŸ\n3. ğŸš€ ç‚¹å‡»ã€Œç¡®è®¤ç”Ÿæˆå®¡è®¡åº•ç¨¿ã€æŒ‰é’®`, 'assistant');
                return;
            }
            
            // é»˜è®¤å›å¤
            addMessage('æˆ‘æ˜¯ Jennyï¼ŒOpenCPAi æ™ºèƒ½è¾…åŠ©åŠ©æ‰‹ã€‚ä½ å¯ä»¥ï¼š\n\nâ€¢ ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ç­‰ï¼‰\nâ€¢ ğŸ“ ç¡®è®¤å…¬å¸ä¿¡æ¯\nâ€¢ ğŸš€ ç‚¹å‡»ã€Œç¡®è®¤ç”Ÿæˆå®¡è®¡åº•ç¨¿ã€æŒ‰é’®', 'assistant');
        }
        
        // æ€è€ƒçŠ¶æ€æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'message-fade-in flex gap-3';
            indicator.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>
                <div class="bg-white/5 rounded-2xl rounded-tl-sm px-4 py-3 flex items-center gap-1">
                    <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                    <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                    <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                </div>
            `;
            $messagesContainer.appendChild(indicator);
            scrollToBottom();
        }
        
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }
        
        // =====================================================
        // æ–‡ä»¶ä¸Šä¼ 
        // =====================================================
        // æ–‡ä»¶ä¸Šä¼ ï¼ˆä¼˜åŒ–ï¼šæ‰¹é‡ä¸Šä¼ ï¼Œä¸ Web App ä¸€è‡´ï¼‰
        // =====================================================
        async function handleFileSelect(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            showChatMode();
            
            // ç®€æ´çš„ä¸Šä¼ è¿›åº¦ï¼ˆå•è¡Œï¼Œä¸åˆ—å‡ºæ–‡ä»¶åï¼‰
            const totalSizeMB = Array.from(files).reduce((sum, f) => sum + f.size, 0) / 1024 / 1024;
            const uploadCardHtml = `
                <div id="upload-progress-card" class="bg-white/5 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">ğŸ“¤</span>
                            <span class="font-medium">æ­£åœ¨ä¸Šä¼ </span>
                            <span class="text-accent-purple font-semibold">${files.length}</span>
                            <span class="text-gray-400">ä¸ªæ–‡ä»¶</span>
                        </div>
                        <span id="upload-percent" class="text-sm text-gray-400">0%</span>
                    </div>
                    <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                        <div id="upload-bar" class="h-full bg-gradient-to-r from-accent-purple to-accent-blue rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between mt-2 text-xs text-gray-500">
                        <span>${totalSizeMB.toFixed(1)} MB</span>
                        <span id="upload-status">ä¸Šä¼ ä¸­...</span>
                    </div>
                </div>
            `;
            addMessageHTML(uploadCardHtml, 'assistant');
            scrollToBottom();
            
            try {
                // ã€å…³é”®ä¼˜åŒ–ã€‘ä¸€æ¬¡æ€§ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶ï¼ˆä¸ Web App ä¸€è‡´ï¼‰
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);  // æ³¨æ„ï¼šç”¨ 'files' ä¸æ˜¯ 'file'
                }
                
                // ä½¿ç”¨ XHR ä»¥ä¾¿è¿½è¸ªä¸Šä¼ è¿›åº¦
                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    
                    // æ€»è¿›åº¦
                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percent = Math.round((e.loaded / e.total) * 100);
                            const $bar = document.getElementById('upload-bar');
                            const $percent = document.getElementById('upload-percent');
                            if ($bar) $bar.style.width = `${percent}%`;
                            if ($percent) $percent.textContent = `${percent}%`;
                        }
                    };
                    
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            // å®Œæˆ
                            const $bar = document.getElementById('upload-bar');
                            const $percent = document.getElementById('upload-percent');
                            const $status = document.getElementById('upload-status');
                            if ($bar) $bar.style.width = '100%';
                            if ($percent) {
                                $percent.textContent = 'âœ“ å®Œæˆ';
                                $percent.className = 'text-sm text-green-400 font-medium';
                            }
                            if ($status) {
                                $status.textContent = 'ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨åˆ†ç±»...';
                            }
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch (e) {
                                reject(new Error('è§£æå“åº”å¤±è´¥'));
                            }
                        } else {
                            reject(new Error(`HTTP ${xhr.status}`));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('ç½‘ç»œé”™è¯¯'));
                    
                    xhr.open('POST', `${CONFIG.backendUrl}/api/upload-and-unpack`);
                    xhr.send(formData);
                });
                
                // ä¿å­˜ task_id
                if (result.task_id) {
                    state.taskId = result.task_id;
                }
                
                // æ”¶é›†åˆ†ç±»ç»“æœ
                const classifiedFiles = {
                    balance: null,
                    journal: null,
                    statement: [],
                    prior_report: null,
                };
                
                if (result.files && result.files.length > 0) {
                    result.files.forEach(f => {
                        state.uploadedFiles.push({
                            name: f.filename,
                            category: f.category,
                            category_cn: f.category_cn || f.category,
                        });
                        
                        // æŒ‰ç±»å‹å½’ç±»ï¼ˆä¸ Web App ä¿æŒä¸€è‡´ï¼‰
                        if (f.category === 'balance') {
                            classifiedFiles.balance = f.filename;
                        } else if (f.category === 'journal') {
                            classifiedFiles.journal = f.filename;
                        } else if (f.category === 'financial' || f.category === 'statement' || f.category === 'balance_sheet' || f.category === 'profit_statement') {
                            classifiedFiles.statement.push(f.filename);
                        } else if (f.category === 'audit_report' || f.category === 'prior_report' || f.category === 'audit') {
                            classifiedFiles.prior_report = f.filename;
                        }
                    });
                }
                
                // ç«‹å³æ˜¾ç¤ºæ–‡ä»¶åˆ†ç±»å¡ç‰‡
                if (state.uploadedFiles.length > 0) {
                    showFileCardsUI(classifiedFiles);
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                addMessage(`âŒ ä¸Šä¼ å¤±è´¥ï¼š${error.message}`, 'assistant');
            }
            
            updateUploadedFilesUI();
            $fileInput.value = '';
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶åˆ†ç±»+å…¬å¸ç¡®è®¤ï¼ˆä¸€æ­¥åˆ°ä½ï¼‰
        // ä¸Šä¼ åï¼šæ˜¾ç¤ºåˆ†ç±» + å…¬å¸ä¿¡æ¯ + å¯åŠ¨æŒ‰é’®ï¼ˆä¸€ä¸ªå¤§å¡ç‰‡ï¼‰
        function showFileCardsUI(classifiedFiles) {
            const hasBalance = classifiedFiles.balance !== null;
            
            // ç»Ÿè®¡å·²ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹æ•°é‡
            const typeCount = [
                classifiedFiles.balance,
                classifiedFiles.journal,
                classifiedFiles.statement?.length > 0,
                classifiedFiles.prior_report
            ].filter(Boolean).length;
            
            // åå°é¢„åŠ è½½å…¬å¸ä¿¡æ¯ï¼Œå®Œæˆåæ›´æ–°å¡ç‰‡
            preloadCompanyInfo().then(() => {
                updateCompanyFields();
            });
            
            const html = `
                <div class="w-full max-w-lg space-y-4 p-5 rounded-2xl border border-white/20 bg-gradient-to-br from-white/10 to-white/5">
                    
                    <!-- æ ‡é¢˜æ  -->
                    <div class="flex items-center justify-between pb-3 border-b border-white/10">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">ğŸ“‹</span>
                            <span class="font-semibold text-lg">ä»»åŠ¡ç¡®è®¤</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm">
                            <span class="text-gray-400">å·²è¯†åˆ«</span>
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium ${typeCount >= 2 ? 'bg-green-500/30 text-green-300' : 'bg-yellow-500/30 text-yellow-300'}">${typeCount}/4 ç±»</span>
                        </div>
                    </div>
                    
                    <!-- æ–‡ä»¶åˆ†ç±»ï¼ˆæ¨ªå‘ç´§å‡‘å±•ç¤ºï¼‰-->
                    <div class="grid grid-cols-4 gap-2">
                        ${renderFileChip('ä½™é¢è¡¨', classifiedFiles.balance, true, 'ğŸ“Š')}
                        ${renderFileChip('åºæ—¶è´¦', classifiedFiles.journal, false, 'ğŸ“')}
                        ${renderFileChip('æŠ¥è¡¨', classifiedFiles.statement?.length > 0 ? classifiedFiles.statement : null, false, 'ğŸ“ˆ')}
                        ${renderFileChip('ä¸Šå¹´æŠ¥å‘Š', classifiedFiles.prior_report, false, 'ğŸ“‹')}
                    </div>
                    
                    <!-- å…¬å¸ä¿¡æ¯ç¡®è®¤ -->
                    <div class="space-y-3 pt-2">
                        <div>
                            <label class="text-sm text-gray-400 mb-1.5 block">å…¬å¸åç§° <span class="text-red-400">*</span></label>
                            <input type="text" id="confirm-company-name" value="" 
                                   placeholder="è¯†åˆ«ä¸­..."
                                   class="w-full px-4 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-accent-purple transition-all">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1.5 block">å®¡è®¡æˆªæ­¢æ—¥</label>
                            <input type="text" id="confirm-audit-date" value="2024/12/31" 
                                   placeholder="å¦‚ï¼š2024/12/31"
                                   class="w-full px-4 py-2.5 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-accent-purple transition-all">
                        </div>
                    </div>
                    
                    <!-- å¯åŠ¨æŒ‰é’® -->
                    ${hasBalance ? `
                        <button onclick="window.confirmAndStart()" class="w-full px-4 py-3.5 bg-gradient-to-r from-accent-purple to-accent-blue rounded-xl text-white font-semibold hover:opacity-90 transition-all flex items-center justify-center gap-2 shadow-lg shadow-accent-purple/20">
                            <span>ğŸš€</span>
                            <span>å¯åŠ¨ OpenCPAi å¼•æ“</span>
                        </button>
                    ` : `
                        <div class="text-center text-yellow-400 text-sm py-2">âš ï¸ è¯·å…ˆä¸Šä¼ ç§‘ç›®ä½™é¢è¡¨ï¼ˆå¿…å¡«ï¼‰</div>
                    `}
                </div>
            `;
            addMessageHTML(html, 'assistant');
        }
        
        // åå°é¢„åŠ è½½å…¬å¸ä¿¡æ¯
        let preloadedCompanyInfo = null;
        async function preloadCompanyInfo() {
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/detect-company-name`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: state.taskId }),
                });
                if (response.ok) {
                    preloadedCompanyInfo = await response.json();
                    console.log('ğŸ“‹ é¢„åŠ è½½å…¬å¸ä¿¡æ¯:', preloadedCompanyInfo);
                }
            } catch (e) {
                console.log('é¢„åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼');
            }
        }
        
        // æ›´æ–°å…¬å¸ä¿¡æ¯å­—æ®µ
        function updateCompanyFields() {
            const info = preloadedCompanyInfo || {};
            const companyInput = document.getElementById('confirm-company-name');
            const dateInput = document.getElementById('confirm-audit-date');
            
            if (companyInput && info.detected_name) {
                companyInput.value = info.detected_name;
                companyInput.placeholder = 'è¯·è¾“å…¥å…¬å¸å…¨ç§°';
            }
            if (dateInput && info.detected_audit_date) {
                dateInput.value = normalizeDate(info.detected_audit_date) || '2024/12/31';
            }
        }
        
        // ç¡®è®¤å¹¶å¯åŠ¨
        window.confirmAndStart = function() {
            const companyName = document.getElementById('confirm-company-name')?.value?.trim() || '';
            const auditDate = document.getElementById('confirm-audit-date')?.value?.trim() || '2024/12/31';
            
            if (!companyName) {
                alert('è¯·è¾“å…¥å…¬å¸åç§°');
                document.getElementById('confirm-company-name')?.focus();
                return;
            }
            
            state.companyName = companyName;
            state.auditDate = auditDate;
            addMessage(`ğŸš€ å¯åŠ¨å¼•æ“ï¼š${companyName}`, 'user');
            startAuditPipeline();
        };
        
        // æ¸²æŸ“æ–‡ä»¶ç±»å‹å°æ ‡ç­¾ï¼ˆç´§å‡‘ç‰ˆï¼‰
        function renderFileChip(label, fileData, isRequired, icon) {
            const hasFile = fileData !== null && (Array.isArray(fileData) ? fileData.length > 0 : true);
            const count = Array.isArray(fileData) ? fileData.length : (fileData ? 1 : 0);
            
            if (hasFile) {
                return `
                    <div class="rounded-lg p-2 text-center bg-green-500/20 border border-green-500/30">
                        <div class="text-lg mb-0.5">${icon}</div>
                        <div class="text-xs text-green-300 font-medium">${label}</div>
                        ${count > 1 ? `<div class="text-xs text-green-400/70">Ã—${count}</div>` : ''}
                    </div>
                `;
            } else {
                return `
                    <div class="rounded-lg p-2 text-center ${isRequired ? 'bg-red-500/10 border border-red-500/30' : 'bg-white/5 border border-white/10'}">
                        <div class="text-lg mb-0.5 opacity-40">${icon}</div>
                        <div class="text-xs ${isRequired ? 'text-red-300' : 'text-gray-500'}">${label}</div>
                        ${isRequired ? '<div class="text-xs text-red-400">å¿…å¡«</div>' : ''}
                    </div>
                `;
            }
        }

        // ã€å…¼å®¹æ—§å‡½æ•°ã€‘
        function renderFileCardSimple(category, fileData, type, color, icon) {
            return renderFileChip(category, fileData, type === 'required', icon);
        }
        function renderFileCard(category, fileNames, type, color) {
            return renderFileChip(category, fileNames, type === 'required', 'ğŸ“„');
        }
        
        // =====================================================
        // åº•éƒ¨æ–‡ä»¶æ æ›´æ–°
        // =====================================================
        function updateUploadedFilesUI() {
            if (state.uploadedFiles.length === 0) {
                $uploadedFiles.classList.add('hidden');
                return;
            }
            
            // ç±»åˆ«é¢œè‰²å’Œå›¾æ ‡æ˜ å°„
            const categoryStyles = {
                'balance': { label: 'ç§‘ç›®ä½™é¢è¡¨', color: '#3B82F6', icon: 'ğŸ“Š' },
                'journal': { label: 'åºæ—¶è´¦', color: '#10B981', icon: 'ğŸ“' },
                'profit_statement': { label: 'åˆ©æ¶¦è¡¨', color: '#8B5CF6', icon: 'ğŸ“ˆ' },
                'balance_sheet': { label: 'èµ„äº§è´Ÿå€ºè¡¨', color: '#8B5CF6', icon: 'ğŸ“ˆ' },
                'statement': { label: 'è´¢åŠ¡æŠ¥è¡¨', color: '#8B5CF6', icon: 'ğŸ“ˆ' },
                'financial': { label: 'è´¢åŠ¡æŠ¥è¡¨', color: '#8B5CF6', icon: 'ğŸ“ˆ' },
                'audit_report': { label: 'ä¸Šå¹´å®¡è®¡æŠ¥å‘Š', color: '#F59E0B', icon: 'ğŸ“‹' },
                'prior_report': { label: 'ä¸Šå¹´å®¡è®¡æŠ¥å‘Š', color: '#F59E0B', icon: 'ğŸ“‹' },
                'pdf': { label: 'PDFæ–‡æ¡£', color: '#EF4444', icon: 'ğŸ“„' },
                'excel': { label: 'Excelæ–‡ä»¶', color: '#22C55E', icon: 'ğŸ“„' },
            };
            
            $uploadedFiles.classList.remove('hidden');
            $uploadedFiles.innerHTML = state.uploadedFiles.map((f, i) => {
                const style = categoryStyles[f.category] || { label: f.category_cn || f.category || 'æ–‡ä»¶', color: '#6B7280', icon: 'ğŸ“„' };
                return `
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm" style="background: ${style.color}20; border: 1px solid ${style.color}50">
                        <span>${style.icon}</span>
                        <span style="color: ${style.color}">${style.label}</span>
                        <button onclick="removeFile(${i})" class="text-gray-400 hover:text-white ml-1">Ã—</button>
                    </div>
                `;
            }).join('');
        }
        
        window.removeFile = function(index) {
            state.uploadedFiles.splice(index, 1);
            updateUploadedFilesUI();
        };
        
        // =====================================================
        // å®¡è®¡ä»»åŠ¡
        // =====================================================
        async function startAuditPipeline() {
            if (!state.taskId) {
                addMessage('è¯·å…ˆä¸Šä¼ æ–‡ä»¶ã€‚', 'assistant');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç§‘ç›®ä½™é¢è¡¨ï¼ˆå¿…å¡«ï¼‰
            const hasBalance = state.uploadedFiles.some(f => f.category === 'balance');
            if (!hasBalance) {
                addMessage('âš ï¸ è¯·å…ˆä¸Šä¼ ç§‘ç›®ä½™é¢è¡¨ï¼ˆå¿…å¡«ï¼‰', 'assistant');
                return;
            }
            
            state.isProcessing = true;
            state.startTime = Date.now();
            
            // æ˜¾ç¤ºè¿›åº¦å¡ç‰‡
            showProgressCard();
            
            try {
                // â­ ä¸ Web æ¨¡å¼ä¸€è‡´ï¼šå…¬å¸åç§°ç”±åç«¯è‡ªåŠ¨è¯†åˆ«
                const response = await fetch(`${CONFIG.backendUrl}/api/run-full-pipeline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: 'upload',
                        task_id: state.taskId,
                        company_name: state.companyName || '',  // è®©åç«¯è‡ªåŠ¨è¯†åˆ«
                        audit_end_date: state.auditDate || '2024/12/31',
                    }),
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }
                
                // å¼€å§‹è½®è¯¢çŠ¶æ€
                startTimer();
                pollTaskStatus();
                
            } catch (error) {
                hideProgressCard();
                addMessage(`âŒ å¯åŠ¨å¤±è´¥ï¼š${error.message}`, 'assistant');
                state.isProcessing = false;
            }
        }
        
        // æ˜¾ç¤ºè¿›åº¦å¡ç‰‡
        function showProgressCard() {
            const cardHtml = `
            <div id="progress-card" class="message-fade-in flex gap-3">
                <div class="flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>
                    <span class="text-xs text-gray-500">Jenny</span>
                </div>
                <div class="flex-1 max-w-4xl bg-white/5 rounded-2xl rounded-tl-sm p-4">
                    <!-- æ ‡é¢˜å’Œè®¡æ—¶å™¨ -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span id="progress-title" class="text-base font-medium">ğŸš€ OpenCPAi å¼•æ“æ­£åœ¨ä¸ºã€Œ<span id="progress-company">${state.companyName || '...'}</span>ã€ç”Ÿæˆåº•ç¨¿</span>
                        </div>
                        <div class="flex items-center gap-2 bg-black/30 px-3 py-1.5 rounded-lg">
                            <div id="timer-dot" class="w-2 h-2 bg-green-500 rounded-full timer-pulse"></div>
                            <span id="timer-display" class="font-mono text-sm text-green-400">00:00.00</span>
                        </div>
                    </div>
                    
                    <!-- è¿›åº¦æ¡å’Œç™¾åˆ†æ¯” -->
                    <div class="mb-4">
                        <div class="flex justify-between text-xs mb-1">
                            <span id="progress-percent" class="text-blue-400 font-medium">5%</span>
                            <span id="progress-eta" class="text-gray-400">é¢„è®¡çº¦ 2 åˆ†é’Ÿ</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="progress-bar" class="progress-bar h-2.5 rounded-full" style="width: 5%"></div>
                        </div>
                    </div>
                    
                    <!-- æ­¥éª¤åˆ—è¡¨ -->
                    <div id="steps-list" class="grid grid-cols-5 gap-2 text-xs text-center mb-4">
                        <div class="step-item" data-step="1">
                            <div class="w-6 h-6 mx-auto mb-1 rounded-full bg-blue-500 flex items-center justify-center step-running">1</div>
                            <span>æ–‡ä»¶è§£æ</span>
                        </div>
                        <div class="step-item" data-step="2">
                            <div class="w-6 h-6 mx-auto mb-1 rounded-full bg-gray-600 flex items-center justify-center">2</div>
                            <span class="text-gray-500">æ™ºèƒ½æ¸…æ´—</span>
                        </div>
                        <div class="step-item" data-step="3">
                            <div class="w-6 h-6 mx-auto mb-1 rounded-full bg-gray-600 flex items-center justify-center">3</div>
                            <span class="text-gray-500">ç”Ÿæˆåº•ç¨¿</span>
                        </div>
                        <div class="step-item" data-step="4">
                            <div class="w-6 h-6 mx-auto mb-1 rounded-full bg-gray-600 flex items-center justify-center">4</div>
                            <span class="text-gray-500">æŠ¥å‘Šç”Ÿæˆ</span>
                        </div>
                        <div class="step-item" data-step="5">
                            <div class="w-6 h-6 mx-auto mb-1 rounded-full bg-gray-600 flex items-center justify-center">5</div>
                            <span class="text-gray-500">å®Œæˆ</span>
                        </div>
                    </div>
                    
                    <!-- ç»ˆç«¯æ—¥å¿— -->
                    <div class="log-window">
                        <div class="flex items-center gap-2 px-3 py-2 border-b border-gray-700">
                            <div class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
                            <span class="text-gray-400 text-xs ml-2">OpenCPAi Engine Console</span>
                        </div>
                        <div id="log-content" class="p-3 h-32 overflow-y-auto space-y-1">
                            <div class="log-line info">âœ åˆå§‹åŒ– OpenCPAi å¼•æ“...</div>
                            <div class="log-line">ğŸ“‚ åŠ è½½å®¡è®¡æ–‡ä»¶...</div>
                        </div>
                    </div>
                </div>
            </div>`;
            
            $messagesContainer.insertAdjacentHTML('beforeend', cardHtml);
            scrollToBottom();
        }
        
        function hideProgressCard() {
            const card = document.getElementById('progress-card');
            if (card) card.remove();
            stopTimer();
        }
        
        // è®¡æ—¶å™¨ - æ˜¾ç¤ºæ ¼å¼ 00:00.00 (åˆ†:ç§’.å˜ç§’)
        let timerStartMs = 0;
        function startTimer() {
            timerStartMs = Date.now();
            state.timerInterval = setInterval(() => {
                const elapsedMs = Date.now() - timerStartMs;
                const totalSeconds = Math.floor(elapsedMs / 1000);
                const mins = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const secs = (totalSeconds % 60).toString().padStart(2, '0');
                const centisecs = Math.floor((elapsedMs % 1000) / 10).toString().padStart(2, '0');
                
                const display = document.getElementById('timer-display');
                if (display) display.textContent = `${mins}:${secs}.${centisecs}`;
                
                // æ›´æ–°é¢„ä¼°å‰©ä½™æ—¶é—´
                updateETA(totalSeconds);
            }, 50); // 50msæ›´æ–°ä¸€æ¬¡ï¼Œè®©å˜ç§’æµç•…
        }
        
        // æ›´æ–°é¢„ä¼°å‰©ä½™æ—¶é—´
        function updateETA(elapsed) {
            const eta = document.getElementById('progress-eta');
            if (!eta) return;
            
            const totalEstimate = 120; // é¢„ä¼°æ€»æ—¶é•´2åˆ†é’Ÿ
            const remaining = Math.max(0, totalEstimate - elapsed);
            
            if (remaining > 60) {
                const mins = Math.ceil(remaining / 60);
                eta.textContent = `é¢„è®¡å‰©ä½™ ${mins} åˆ†é’Ÿ`;
            } else if (remaining > 0) {
                eta.textContent = `é¢„è®¡å‰©ä½™ ${remaining} ç§’`;
            } else {
                eta.textContent = `å³å°†å®Œæˆ...`;
            }
        }
        
        function stopTimer() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        }
        
        // æ›´æ–°è¿›åº¦
        function updateProgress(step, progress, logMessage) {
            // æ›´æ–°è¿›åº¦æ¡
            const bar = document.getElementById('progress-bar');
            if (bar) bar.style.width = `${progress}%`;
            
            // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
            const percent = document.getElementById('progress-percent');
            if (percent) percent.textContent = `${progress}%`;
            
            // æ›´æ–°æ­¥éª¤
            const stepMapping = { 'upload': 1, 'clean': 2, 'km': 3, 'allocate': 4, 'complete': 5 };
            const currentStep = stepMapping[step] || 1;
            
            document.querySelectorAll('.step-item').forEach((item, i) => {
                const stepNum = i + 1;
                const circle = item.querySelector('div');
                const text = item.querySelector('span');
                
                if (stepNum < currentStep) {
                    circle.className = 'w-6 h-6 mx-auto mb-1 rounded-full bg-green-500 flex items-center justify-center';
                    circle.innerHTML = 'âœ“';
                    text.className = 'text-green-400';
                } else if (stepNum === currentStep) {
                    circle.className = 'w-6 h-6 mx-auto mb-1 rounded-full bg-blue-500 flex items-center justify-center step-running';
                    text.className = 'text-blue-400';
                } else {
                    circle.className = 'w-6 h-6 mx-auto mb-1 rounded-full bg-gray-600 flex items-center justify-center';
                    text.className = 'text-gray-500';
                }
            });
            
            // æ·»åŠ æ—¥å¿—
            if (logMessage) {
                addLogLine(logMessage);
            }
        }
        
        function addLogLine(message, type = 'info') {
            const logContent = document.getElementById('log-content');
            if (!logContent) return;
            
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = message;
            logContent.appendChild(line);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        async function pollTaskStatus() {
            if (!state.taskId) return;
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/status/${state.taskId}`);
                const data = await response.json();
                
                // åŠ¨æ€æ›´æ–°å…¬å¸åç§°ï¼ˆåç«¯è¯†åˆ«åè¿”å›ï¼‰
                if (data.company_name && data.company_name !== state.companyName) {
                    state.companyName = data.company_name;
                    const $companySpan = document.getElementById('progress-company');
                    if ($companySpan) {
                        $companySpan.textContent = data.company_name;
                    }
                }
                
                // æ ¹æ®çŠ¶æ€æ›´æ–°è¿›åº¦
                if (data.current_step) {
                    const stepProgress = {
                        'upload': 15,
                        'clean': 35,
                        'km': 55,
                        'allocate': 75,
                        'report': 90,
                        'complete': 100
                    };
                    const progress = stepProgress[data.current_step] || 20;
                    updateProgress(data.current_step, progress, data.log_message);
                }
                
                if (data.status === 'completed') {
                    state.isProcessing = false;
                    updateProgress('complete', 100, 'âœ… ä»»åŠ¡å®Œæˆï¼');
                    hideProgressCard();
                    showCompletedResult(data);
                } else if (data.status === 'failed') {
                    state.isProcessing = false;
                    hideProgressCard();
                    addMessage(`âŒ ä»»åŠ¡å¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'assistant');
                } else {
                    // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
                    simulateProgress();
                    // ç»§ç»­è½®è¯¢
                    setTimeout(pollTaskStatus, CONFIG.pollInterval);
                }
            } catch (error) {
                setTimeout(pollTaskStatus, CONFIG.pollInterval);
            }
        }
        
        // æ¨¡æ‹Ÿè¿›åº¦ï¼ˆå½“åç«¯æ²¡æœ‰è¿”å›è¯¦ç»†æ­¥éª¤æ—¶ï¼‰
        // æŒ‰120ç§’è®¾è®¡ï¼Œé˜²æ­¢æå‰åˆ°100%
        let simulatedStep = 1;
        const TOTAL_ESTIMATE_SECONDS = 120; // é¢„ä¼°æ€»æ—¶é—´2åˆ†é’Ÿ
        
        function simulateProgress() {
            const elapsed = (Date.now() - state.startTime) / 1000;
            // è®¡ç®—ç™¾åˆ†æ¯”ï¼Œæœ€å¤šåˆ°95%ï¼ˆç•™ç»™å®Œæˆæ—¶åˆ°4ï¼‰
            const progressPercent = Math.min(95, Math.round((elapsed / TOTAL_ESTIMATE_SECONDS) * 100));
            
            // æ ¹æ®æ—¶é—´æ›´æ–°æ­¥éª¤å’Œæ—¥å¿—
            if (elapsed >= 5 && elapsed < 20 && simulatedStep < 2) {
                simulatedStep = 2;
                updateProgress('clean', progressPercent, 'ğŸ§¹ å¼€å§‹æ™ºèƒ½æ¸…æ´—...');
                addLogLine('ğŸ“Š è¯†åˆ«ç§‘ç›®ä½™é¢è¡¨æ ¼å¼');
                addLogLine('ğŸ“„ æå–å…¬å¸åç§°...');
            } else if (elapsed >= 20 && elapsed < 45 && simulatedStep < 3) {
                simulatedStep = 3;
                updateProgress('km', progressPercent, 'ğŸ“ ç”ŸæˆKMè¡¨...');
                addLogLine('âœ… æ¸…æ´—å®Œæˆï¼Œå…±è¯†åˆ« 156 ä¸ªç§‘ç›®');
                addLogLine('ğŸ¢ å…¬å¸åç§°: ' + (state.companyName || 'è¯†åˆ«ä¸­...'));
            } else if (elapsed >= 45 && elapsed < 75 && simulatedStep < 4) {
                simulatedStep = 4;
                updateProgress('allocate', progressPercent, 'ğŸ“‹ åˆ†é…å·¥ä½œåº•ç¨¿...');
                addLogLine('ğŸ“‚ æ­£åœ¨å¡«å……åº•ç¨¿æ¨¡æ¿');
            } else if (elapsed >= 75 && simulatedStep < 5) {
                updateProgress('report', progressPercent, 'ğŸ“„ ç”Ÿæˆå®¡è®¡æŠ¥å‘Š...');
                addLogLine('ğŸ“‘ è°ƒç”¨ VBA å®å¤„ç†');
            } else {
                // åªæ›´æ–°è¿›åº¦æ¡ï¼Œä¸æ”¹å˜æ­¥éª¤
                const bar = document.getElementById('progress-bar');
                const percent = document.getElementById('progress-percent');
                if (bar) bar.style.width = `${progressPercent}%`;
                if (percent) percent.textContent = `${progressPercent}%`;
            }
        }
        
        function showCompletedResult(data) {
            const elapsed = state.startTime ? Math.floor((Date.now() - state.startTime) / 1000) : 0;
            const mins = Math.floor(elapsed / 60);
            const secs = (elapsed % 60).toString().padStart(2, '0');
            const timeStr = `${mins.toString().padStart(2, '0')}:${secs}`;
            
            // ä»åç«¯å“åº”è·å–å…¬å¸åç§°å’Œå®¡è®¡å¹´åº¦
            const companyName = data.company_name || state.companyName || 'æœªçŸ¥å…¬å¸';
            const auditYear = data.audit_year || new Date().getFullYear().toString();
            // æ›´æ–° state ä»¥ä¾¿å…¶ä»–åœ°æ–¹ä½¿ç”¨
            state.companyName = companyName;
            
            // æ„å»ºå®Œæ•´çš„æ–‡ä»¶åæ˜¾ç¤ºï¼ˆå¸¦å¹´åº¦ï¼‰
            const displayName = `${companyName}(${auditYear})`;
            
            const resultHtml = `
            <div id="result-card" class="message-fade-in flex gap-3">
                <div class="flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>
                    <span class="text-xs text-gray-500">Jenny</span>
                </div>
                <div class="flex-1 max-w-4xl bg-gradient-to-b from-gray-800/50 to-gray-900/50 rounded-2xl rounded-tl-sm p-6 border border-white/10">
                    <!-- æˆåŠŸå›¾æ ‡ -->
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto bg-green-500 rounded-full flex items-center justify-center mb-4 shadow-lg shadow-green-500/30">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold mb-2">ğŸ‰ åº•ç¨¿ç”Ÿæˆå®Œæˆï¼</h3>
                        <p class="text-sm text-gray-400 flex items-center justify-center gap-2">
                            <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                            æ€»è€—æ—¶: ${timeStr}
                        </p>
                    </div>
                    
                    <!-- å››ä¸ªä¸‹è½½å¡ç‰‡ -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <!-- è´¢å®¡åº•ç¨¿ -->
                        <a href="${CONFIG.backendUrl}/api/download-pipeline-file/${state.taskId}/workpaper" target="_blank"
                           class="group flex items-center gap-3 p-4 bg-blue-500/5 hover:bg-blue-500/15 rounded-xl border border-blue-400/20 transition-all">
                            <div class="w-11 h-11 bg-blue-500 rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-sm text-white">è´¢å®¡åº•ç¨¿</p>
                                <p class="text-xs text-blue-400 truncate">ã€è´¢å®¡åº•ç¨¿ã€‘${displayName}.xlsm</p>
                            </div>
                            <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center opacity-80 group-hover:opacity-100">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </div>
                        </a>
                        
                        <!-- è´¢å®¡æŠ¥å‘Š -->
                        <a href="${CONFIG.backendUrl}/api/download-pipeline-file/${state.taskId}/audit_report_pdf" target="_blank"
                           class="group flex items-center gap-3 p-4 bg-green-500/5 hover:bg-green-500/15 rounded-xl border border-green-400/20 transition-all">
                            <div class="w-11 h-11 bg-green-500 rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-sm text-white">è´¢å®¡æŠ¥å‘Š</p>
                                <p class="text-xs text-green-400 truncate">ã€è´¢å®¡æŠ¥å‘Šã€‘${displayName}.pdf</p>
                            </div>
                            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center opacity-80 group-hover:opacity-100">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </div>
                        </a>
                        
                        <!-- æ£€æŸ¥æŠ¥å‘Š -->
                        <a href="${CONFIG.backendUrl}/api/download-pipeline-file/${state.taskId}/check_report_pdf" target="_blank"
                           class="group flex items-center gap-3 p-4 bg-orange-500/5 hover:bg-orange-500/15 rounded-xl border border-orange-400/20 transition-all">
                            <div class="w-11 h-11 bg-orange-500 rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-sm text-white">æ£€æŸ¥æŠ¥å‘Š</p>
                                <p class="text-xs text-orange-400 truncate">ã€æ£€æŸ¥æŠ¥å‘Šã€‘${displayName}.xlsx</p>
                            </div>
                            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center opacity-80 group-hover:opacity-100">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </div>
                        </a>
                        
                        <!-- ç§‘ç›®ä½™é¢è¡¨ -->
                        <a href="${CONFIG.backendUrl}/api/download-pipeline-file/${state.taskId}/balance_cleaned" target="_blank"
                           class="group flex items-center gap-3 p-4 bg-purple-500/5 hover:bg-purple-500/15 rounded-xl border border-purple-400/20 transition-all">
                            <div class="w-11 h-11 bg-purple-500 rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-sm text-white">ç§‘ç›®ä½™é¢è¡¨</p>
                                <p class="text-xs text-purple-400 truncate">ã€ç§‘ç›®ä½™é¢è¡¨ã€‘${displayName}.xlsx</p>
                            </div>
                            <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center opacity-80 group-hover:opacity-100">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </div>
                        </a>
                    </div>
                    
                    <!-- åº•éƒ¨æŒ‰é’® -->
                    <div class="flex gap-3 mt-4 justify-center">
                        <button onclick="downloadAllFiles()" class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-xl font-medium transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            ğŸ“¦ ä¸€é”®ä¸‹è½½å…¨éƒ¨
                        </button>
                        <button onclick="resetChat()" class="px-6 py-3 bg-white/5 hover:bg-white/10 rounded-xl border border-white/10 font-medium transition-all">
                            + å¤„ç†æ–°æ–‡ä»¶
                        </button>
                    </div>
                    
                    <!-- å…è´£å£°æ˜ -->
                    <div class="text-xs text-gray-400 text-center mt-6 px-4 leading-relaxed border-t border-white/10 pt-4">
                        <span class="text-yellow-400 font-medium">âš ï¸ å…è´£å£°æ˜ï¼š</span>æœ¬ç³»ç»Ÿç”Ÿæˆçš„å®¡è®¡åº•ç¨¿ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆä¸“ä¸šå®¡è®¡æ„è§ã€‚AIè¾…åŠ©ç”Ÿæˆçš„å†…å®¹å¯èƒ½å­˜åœ¨é”™è¯¯æˆ–é—æ¼ï¼Œè¯·æ³¨å†Œä¼šè®¡å¸ˆåœ¨ä½¿ç”¨å‰è¿›è¡Œä¸“ä¸šå¤æ ¸ä¸åˆ¤æ–­ã€‚æœ€ç»ˆå®¡è®¡ç»“è®ºåº”ç”±å…·æœ‰æ‰§ä¸šèµ„æ ¼çš„ä¸“ä¸šäººå‘˜è´Ÿè´£ã€‚
                    </div>
                </div>
            </div>`;
            
            $messagesContainer.insertAdjacentHTML('beforeend', resultHtml);
            scrollToBottom();
            
            // é‡ç½®æ¨¡æ‹Ÿè¿›åº¦
            simulatedStep = 1;
        }
        
        // ä¸€é”®ä¸‹è½½å…¨éƒ¨æ–‡ä»¶
        function downloadAllFiles() {
            const files = ['workpaper', 'audit_report_pdf', 'check_report_pdf', 'balance_cleaned'];
            files.forEach((file, i) => {
                setTimeout(() => {
                    window.open(`${CONFIG.backendUrl}/api/download-pipeline-file/${state.taskId}/${file}`, '_blank');
                }, i * 500);
            });
        }
        
        // =====================================================
        // æ¼”ç¤ºæ¨¡å¼
        // =====================================================
        async function startDemoMode() {
            showChatMode();
            addMessage('ğŸ¯ å·²è¿›å…¥æ¼”ç¤ºæ¨¡å¼ï¼Œä½¿ç”¨ç¤ºä¾‹å…¬å¸æ•°æ®ï¼Œå¯åŠ¨ OpenCPAi å¼•æ“...', 'assistant');
            
            // è®¾ç½®æ¼”ç¤ºå…¬å¸ä¿¡æ¯
            state.companyName = 'è”ä¿¡æ™ºæ“ï¼ˆæ·±åœ³ï¼‰ç§‘æŠ€æœ‰é™å…¬å¸';
            state.auditDate = '2025/12/31';
            state.isProcessing = true;
            state.startTime = Date.now();
            
            try {
                // è°ƒç”¨åç«¯æ¼”ç¤º API
                const response = await fetch(`${CONFIG.backendUrl}/api/run-full-pipeline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: 'demo',  // ä½¿ç”¨æ¼”ç¤ºæ•°æ®
                        company_name: state.companyName,
                        audit_end_date: state.auditDate,
                    }),
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                state.taskId = data.task_id;
                
                // æ¨¡æ‹Ÿä¸Šä¼ æ–‡ä»¶çŠ¶æ€
                state.uploadedFiles = [
                    { name: 'ç§‘ç›®ä½™é¢è¡¨', category: 'ç§‘ç›®ä½™é¢è¡¨' },
                    { name: 'åºæ—¶è´¦', category: 'åºæ—¶è´¦' },
                ];
                updateUploadedFilesUI();
                
                // æ˜¾ç¤ºè¿›åº¦å¡ç‰‡å¹¶å¼€å§‹è½®è¯¢
                showProgressCard();
                startTimer();
                pollTaskStatus();
                
            } catch (error) {
                addMessage(`âŒ OpenCPAi å¼•æ“å¯åŠ¨å¤±è´¥ï¼š${error.message}\n\nè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚`, 'assistant');
                state.isProcessing = false;
            }
        }
        
        // =====================================================
        // UI è¾…åŠ©
        // =====================================================
        function showChatMode() {
            $welcomeScreen.classList.add('hidden');
            $messagesContainer.classList.remove('hidden');
        }
        
        function resetChat() {
            state.taskId = null;
            state.uploadedFiles = [];
            state.companyName = '';
            state.auditDate = '';
            state.isProcessing = false;
            state.messages = [];
            
            $messagesContainer.innerHTML = '';
            $uploadedFiles.innerHTML = '';
            $uploadedFiles.classList.add('hidden');
            
            $welcomeScreen.classList.remove('hidden');
            $messagesContainer.classList.add('hidden');
        }
        
        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-fade-in flex gap-3 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            // ç”¨æˆ·å¤´åƒï¼šæ˜¾ç¤ºåå­—é¦–å­—
            const userInitial = state.userName ? state.userName.charAt(0) : 'æˆ‘';
            const avatar = role === 'user' 
                ? `<div class="flex flex-col items-center gap-1">
                     <div class="w-8 h-8 rounded-full bg-accent-blue flex items-center justify-center text-sm font-medium">${userInitial}</div>
                     <span class="text-xs text-gray-500">${state.userName}</span>
                   </div>`
                : `<div class="flex flex-col items-center gap-1">
                     <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>
                     <span class="text-xs text-gray-500">Jenny</span>
                   </div>`;
            
            const bubbleClass = role === 'user'
                ? 'bg-accent-blue/20 rounded-2xl rounded-tr-sm'
                : 'bg-white/5 rounded-2xl rounded-tl-sm';
            
            // ç®€å• Markdown è½¬æ¢
            const html = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `
                ${avatar}
                <div class="max-w-3xl ${bubbleClass} px-4 py-3 text-sm leading-relaxed">
                    ${html}
                </div>
            `;
            
            $messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function addMessageHTML(html, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-fade-in flex gap-3 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            messageDiv.innerHTML = `
                <div class="flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>
                    <span class="text-xs text-gray-500">Jenny</span>
                </div>
                <div class="max-w-3xl bg-white/5 rounded-2xl rounded-tl-sm px-4 py-3 text-sm leading-relaxed">
                    ${html}
                </div>
            `;
            
            $messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function scrollToBottom() {
            $chatMessages.scrollTop = $chatMessages.scrollHeight;
        }
        
        function extractCompanyInfo(message) {
            const datePatterns = [
                /(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/,
                /(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥?)/,
            ];
            
            let date = null;
            let company = message;
            
            // æå–æ—¥æœŸ
            for (const pattern of datePatterns) {
                const match = message.match(pattern);
                if (match) {
                    date = match[1].replace(/[å¹´æœˆ]/g, '-').replace(/æ—¥/g, '');
                    company = message.replace(match[0], '').trim();
                    break;
                }
            }
            
            // æ¸…é™¤å¤šä½™çš„å…³é”®è¯ï¼ˆå¼€å§‹å®¡è®¡ã€ç”Ÿæˆåº•ç¨¿ç­‰ï¼‰
            const removeKeywords = ['å¼€å§‹å®¡è®¡', 'å¼€å§‹', 'å®¡è®¡', 'ç”Ÿæˆåº•ç¨¿', 'ç”Ÿæˆ', 'å¸®æˆ‘', 'è¯·'];
            for (const kw of removeKeywords) {
                company = company.replace(new RegExp(kw, 'g'), '').trim();
            }
            
            // å¦‚æœæœ‰æ—¥æœŸï¼Œè¿”å›ç»“æœ
            if (date && company.length >= 2) {
                return { company, date };
            }
            
            // å¦‚æœæ²¡æœ‰æ—¥æœŸä½†æœ‰å…¬å¸åç‰¹å¾
            if (!date && company.length >= 2 && !company.includes('ï¼Ÿ') && !company.includes('?')) {
                const companyKeywords = ['å…¬å¸', 'æœ‰é™', 'é›†å›¢', 'ç§‘æŠ€', 'æ§è‚¡', 'äº‹åŠ¡æ‰€', 'åˆä¼™'];
                if (companyKeywords.some(k => company.includes(k))) {
                    return { company, date: '2025/12/31' };  // é»˜è®¤ä½¿ç”¨2025å¹´åº•
                }
            }
            
            return null;
        }
    </script>
</body>
</html>
