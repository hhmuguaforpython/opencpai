<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCPAi - AIå®¡è®¡åŠ©æ‰‹</title>
    
    <!-- SEO -->
    <meta name="description" content="OpenCPAi AIå®¡è®¡åŠ©æ‰‹ - ä¸Šä¼ æ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆå®¡è®¡åº•ç¨¿">
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-dark': '#0a0a0a',
                        'bg-sidebar': '#171717',
                        'bg-chat': '#0a0a0a',
                        'bg-input': '#1a1a1a',
                        'accent-blue': '#3B82F6',
                        'accent-purple': '#8B5CF6',
                        'accent-green': '#10B981',
                    },
                    fontFamily: {
                        'inter': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* æ¶ˆæ¯åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* æ‰“å­—æŒ‡ç¤ºå™¨ */
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        .typing-dot { animation: bounce 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-zone {
            border: 2px dashed #333;
            transition: all 0.3s;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3B82F6;
            background: rgba(59, 130, 246, 0.05);
        }
        
        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar {
            transition: width 0.5s ease-out;
            background: linear-gradient(90deg, #3B82F6, #8B5CF6, #10B981);
            background-size: 200% 100%;
            animation: progressShimmer 2s linear infinite;
        }
        @keyframes progressShimmer {
            0% { background-position: 100% 0; }
            100% { background-position: -100% 0; }
        }
        
        /* ç»ˆç«¯æ—¥å¿—çª—å£ */
        .log-window {
            background: #0f172a;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }
        .log-line {
            color: #94a3b8;
            line-height: 1.4;
        }
        .log-line.success { color: #10B981; }
        .log-line.info { color: #3B82F6; }
        .log-line.warning { color: #F59E0B; }
        
        /* è®¡æ—¶å™¨è„‰å†² */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .timer-pulse { animation: pulse 1s infinite; }
        
        /* æ­¥éª¤å®ŒæˆåŠ¨ç”» */
        .step-done { color: #10B981; }
        .step-running { color: #3B82F6; animation: pulse 1s infinite; }
        
        /* ç§»åŠ¨ç«¯å“åº”å¼ */
        @media (max-width: 768px) {
            /* éšè—ä¾§è¾¹æ  */
            #sidebar { display: none; }
            
            /* è°ƒæ•´æ¬¢è¿å± */
            #welcome-screen h1 { font-size: 1.5rem; }
            #welcome-screen p { font-size: 0.875rem; }
            
            /* è°ƒæ•´å¿«æ·æŒ‰é’® */
            #welcome-screen .grid-cols-2 { gap: 0.5rem; }
            #welcome-screen button { padding: 0.75rem; }
            
            /* è°ƒæ•´æ¶ˆæ¯å®¹å™¨ */
            #messages-container { padding: 1rem; }
            
            /* è°ƒæ•´è¿›åº¦å¡ç‰‡ */
            .log-window { display: none; }
            #steps-list { grid-template-columns: repeat(5, 1fr); gap: 0.25rem; font-size: 0.65rem; }
            #steps-list .w-6 { width: 1.25rem; height: 1.25rem; font-size: 0.6rem; }
            
            /* è°ƒæ•´ç»“æœå¡ç‰‡ */
            #result-card .grid-cols-2 { grid-template-columns: 1fr; }
            #result-card .flex.gap-3 { flex-direction: column; }
            
            /* è°ƒæ•´è¾“å…¥åŒº */
            #chat-input { font-size: 16px; } /* é˜²æ­¢iOSç¼©æ”¾ */
        }
        
        /* å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            #welcome-screen .flex-wrap { flex-direction: column; }
            #welcome-screen .suggest-prompt { width: 100%; }
        }
    </style>
</head>
<body class="bg-bg-dark text-gray-100 font-inter antialiased h-screen flex">
    
    <!-- ç§»åŠ¨ç«¯å¤´éƒ¨ -->
    <header id="mobile-header" class="fixed top-0 left-0 right-0 z-50 bg-bg-dark/95 backdrop-blur border-b border-white/5 p-3 md:hidden">
        <div class="flex items-center justify-between">
            <a href="../" class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-accent-blue to-accent-purple flex items-center justify-center">
                    <span class="text-white font-bold text-sm">O</span>
                </div>
                <span class="font-semibold">OpenCPAi</span>
            </a>
            <button id="mobile-new-chat" class="p-2 rounded-lg border border-white/10 hover:bg-white/5">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
            </button>
        </div>
    </header>
    
    <!-- ========== SIDEBAR ========== -->
    <aside id="sidebar" class="w-64 bg-bg-sidebar border-r border-white/5 flex-col h-full hidden md:flex">
        <!-- Logo -->
        <div class="p-4 border-b border-white/5">
            <a href="../" class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-accent-blue to-accent-purple flex items-center justify-center">
                    <span class="text-white font-bold">O</span>
                </div>
                <span class="text-lg font-semibold">OpenCPAi</span>
            </a>
        </div>
        
        <!-- New Chat Button -->
        <div class="p-3">
            <button id="new-chat-btn" class="w-full flex items-center gap-2 px-4 py-2.5 rounded-lg border border-white/10 hover:bg-white/5 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span class="text-sm">æ–°å¯¹è¯</span>
            </button>
        </div>
        
        <!-- Chat History -->
        <div class="flex-1 overflow-y-auto p-3">
            <div class="text-xs text-gray-500 px-2 mb-2">å†å²å¯¹è¯</div>
            <div id="chat-history" class="space-y-1">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
        </div>
        
        <!-- User Section -->
        <div class="p-3 border-t border-white/5">
            <a href="../" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/5 transition-colors text-gray-400 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                è¿”å›å®˜ç½‘
            </a>
        </div>
    </aside>
    
    <!-- ========== MAIN CHAT AREA ========== -->
    <main class="flex-1 flex flex-col h-full pt-14 md:pt-0">
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto">
            
            <!-- Welcome Screen (åˆå§‹çŠ¶æ€) -->
            <div id="welcome-screen" class="h-full flex flex-col items-center justify-center px-4">
                <div class="max-w-2xl w-full text-center">
                    <!-- Logo -->
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-accent-blue to-accent-purple flex items-center justify-center mx-auto mb-6">
                        <span class="text-3xl">âœ¨</span>
                    </div>
                    
                    <h1 class="text-2xl font-semibold mb-2">ä½ å¥½ï¼Œæˆ‘æ˜¯ Jenny</h1>
                    <p class="text-gray-400 mb-8">OpenCPAi æ™ºèƒ½è¾…åŠ©åŠ©æ‰‹ï¼Œä¸€é”®ç”Ÿæˆè´¢å®¡åº•ç¨¿</p>
                    
                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 gap-3 max-w-md mx-auto mb-8">
                        <button id="action-upload" class="upload-zone flex flex-col items-center gap-2 p-4 rounded-xl text-left hover:bg-white/5 transition-all">
                            <span class="text-2xl">ğŸ“¤</span>
                            <span class="text-sm font-medium">ä¸Šä¼ æ–‡ä»¶</span>
                            <span class="text-xs text-gray-500">Excel/ZIP</span>
                        </button>
                        <button id="action-demo" class="flex flex-col items-center gap-2 p-4 rounded-xl border border-white/10 text-left hover:bg-white/5 transition-all">
                            <span class="text-2xl">ğŸ¯</span>
                            <span class="text-sm font-medium">æ¼”ç¤ºæ¨¡å¼</span>
                            <span class="text-xs text-gray-500">ä½¿ç”¨ç¤ºä¾‹æ•°æ®</span>
                        </button>
                    </div>
                    
                    <!-- Suggested Prompts -->
                    <div class="flex flex-wrap justify-center gap-2">
                        <button class="suggest-prompt px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 text-sm transition-colors">
                            ğŸš€ å¯åŠ¨ OpenCPAi å¼•æ“
                        </button>
                        <button class="suggest-prompt px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 text-sm transition-colors">
                            å¦‚ä½•ä½¿ç”¨ï¼Ÿ
                        </button>
                        <button class="suggest-prompt px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 text-sm transition-colors">
                            æ”¯æŒä»€ä¹ˆæ ¼å¼ï¼Ÿ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Messages Container (å¯¹è¯çŠ¶æ€) -->
            <div id="messages-container" class="hidden max-w-3xl mx-auto py-8 px-4 space-y-6">
                <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
            
        </div>
        
        <!-- Input Area -->
        <div class="border-t border-white/5 p-4">
            <div class="max-w-3xl mx-auto">
                <!-- å·²ä¸Šä¼ æ–‡ä»¶é¢„è§ˆ -->
                <div id="uploaded-files" class="hidden flex flex-wrap gap-2 mb-3">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
                
                <!-- Input Box -->
                <div class="flex items-end gap-3">
                    <!-- Attach Button -->
                    <button id="attach-btn" class="p-3 rounded-xl bg-bg-input hover:bg-white/10 transition-colors" title="ä¸Šä¼ æ–‡ä»¶">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                        </svg>
                    </button>
                    
                    <!-- Text Input -->
                    <div class="flex-1 relative">
                        <textarea id="chat-input" 
                                  placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œæˆ–ä¸Šä¼ æ–‡ä»¶..." 
                                  rows="1"
                                  class="w-full bg-bg-input border border-white/10 rounded-2xl px-4 py-3 pr-12 text-sm resize-none 
                                         focus:outline-none focus:border-accent-blue/50 focus:ring-2 focus:ring-accent-blue/20
                                         placeholder-gray-500 max-h-32 overflow-y-auto"></textarea>
                        
                        <!-- Send Button -->
                        <button id="send-btn" 
                                class="absolute right-2 bottom-2 p-2 rounded-lg bg-accent-blue hover:bg-accent-blue/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Footer -->
                <p class="text-center text-xs text-gray-600 mt-3">
                    OpenCPAi å¯èƒ½ä¼šäº§ç”Ÿé”™è¯¯ï¼Œè¯·æ ¸å®é‡è¦ä¿¡æ¯
                </p>
            </div>
        </div>
    </main>
    
    <!-- Hidden File Input -->
    <input type="file" id="file-input" class="hidden" accept=".xlsx,.xls,.csv,.zip,.rar,.pdf" multiple>
    
    <!-- JavaScript -->
    <script>
        // =====================================================
        // é…ç½®
        // =====================================================
        const CONFIG = {
            backendUrl: 'https://api.opencpai.com',  // åç«¯APIåœ°å€ï¼ˆé€šè¿‡Cloudflareéš§é“ï¼‰
            pollInterval: 2000,
        };
        
        // =====================================================
        // çŠ¶æ€
        // =====================================================
        const state = {
            taskId: null,
            uploadedFiles: [],
            companyName: '',
            auditDate: '',
            isProcessing: false,
            messages: [],
            userName: 'å®¡è®¡å¸ˆ',  // ç”¨æˆ·åï¼Œå¯ä»ç™»å½•è·å–
            startTime: null,     // ä»»åŠ¡å¼€å§‹æ—¶é—´
            timerInterval: null, // è®¡æ—¶å™¨
        };
        
        // =====================================================
        // DOM å…ƒç´ 
        // =====================================================
        const $welcomeScreen = document.getElementById('welcome-screen');
        const $messagesContainer = document.getElementById('messages-container');
        const $chatMessages = document.getElementById('chat-messages');
        const $input = document.getElementById('chat-input');
        const $sendBtn = document.getElementById('send-btn');
        const $attachBtn = document.getElementById('attach-btn');
        const $fileInput = document.getElementById('file-input');
        const $uploadedFiles = document.getElementById('uploaded-files');
        const $actionUpload = document.getElementById('action-upload');
        const $actionDemo = document.getElementById('action-demo');
        const $newChatBtn = document.getElementById('new-chat-btn');
        
        // =====================================================
        // åˆå§‹åŒ–
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            $input.addEventListener('input', () => {
                $input.style.height = 'auto';
                $input.style.height = Math.min($input.scrollHeight, 128) + 'px';
                $sendBtn.disabled = !$input.value.trim();
            });
            
            // å‘é€æ¶ˆæ¯
            $sendBtn.addEventListener('click', handleSend);
            $input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
            
            // æ–‡ä»¶ä¸Šä¼ 
            $attachBtn.addEventListener('click', () => $fileInput.click());
            $actionUpload.addEventListener('click', () => $fileInput.click());
            $fileInput.addEventListener('change', handleFileSelect);
            
            // æ¼”ç¤ºæ¨¡å¼
            $actionDemo.addEventListener('click', startDemoMode);
            
            // æ–°å¯¹è¯
            $newChatBtn.addEventListener('click', resetChat);
            
            // ç§»åŠ¨ç«¯æ–°å¯¹è¯æŒ‰é’®
            const $mobileNewChat = document.getElementById('mobile-new-chat');
            if ($mobileNewChat) {
                $mobileNewChat.addEventListener('click', resetChat);
            }
            
            // å»ºè®®æé—®
            document.querySelectorAll('.suggest-prompt').forEach(btn => {
                btn.addEventListener('click', () => {
                    $input.value = btn.textContent;
                    $sendBtn.disabled = false;
                    handleSend();
                });
            });
            
            console.log('ğŸš€ OpenCPAi Chat initialized');
        });
        
        // =====================================================
        // å¿«æ·æ“ä½œï¼ˆä¾›æŒ‰é’®ç›´æ¥è°ƒç”¨ï¼‰
        // =====================================================
        window.quickConfirm = function() {
            // ç›´æ¥å¯åŠ¨å¼•æ“ï¼Œä¸èµ° LLM æ„å›¾è¯†åˆ«
            addMessage('ğŸš€ ç¡®è®¤ç”Ÿæˆ', 'user');
            startAuditPipeline();
        };
        
        // =====================================================
        // æ ¸å¿ƒåŠŸèƒ½
        // =====================================================
        function handleSend() {
            const message = $input.value.trim();
            if (!message && state.uploadedFiles.length === 0) return;
            
            // åˆ‡æ¢åˆ°å¯¹è¯æ¨¡å¼
            showChatMode();
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            if (message) {
                addMessage(message, 'user');
                $input.value = '';
                $input.style.height = 'auto';
                $sendBtn.disabled = true;
            }
            
            // å¤„ç†æ„å›¾ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼Œæé€Ÿï¼‰
            processIntentFast(message);
        }
        
        // å¿«é€Ÿæœ¬åœ°æ„å›¾å¤„ç†ï¼šå¸¸è§æ“ä½œä¸è°ƒç”¨ LLMï¼Œç«‹å³å“åº”
        function processIntentFast(message) {
            const msg = message.toLowerCase();
            
            // 1. ç¡®è®¤ç”Ÿæˆ/å¯åŠ¨å¼•æ“ - æœ€å¸¸è§æ“ä½œï¼Œç›´æ¥å¤„ç†
            if ((msg.includes('ç¡®è®¤') && msg.includes('ç”Ÿæˆ')) || 
                (msg.includes('å¯åŠ¨') && msg.includes('å¼•æ“')) || 
                (msg.includes('å¼€å§‹') && msg.includes('ç”Ÿæˆ')) ||
                msg === 'ç¡®è®¤' || msg === 'ç”Ÿæˆ') {
                if (state.uploadedFiles.length === 0) {
                    addMessage('è¯·å…ˆä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ã€åºæ—¶è´¦ç­‰ï¼‰ã€‚', 'assistant');
                    return;
                }
                if (!state.companyName) {
                    addMessage('è¯·æä¾›å…¬å¸åç§°ï¼Œä¾‹å¦‚è¾“å…¥ã€Œè”ä¿¡æ™ºæ“ã€', 'assistant');
                    return;
                }
                startAuditPipeline();
                return;
            }
            
            // 2. å¸®åŠ© - ç›´æ¥æœ¬åœ°å“åº”
            if (msg.includes('å¦‚ä½•') || msg.includes('å¸®åŠ©') || msg.includes('ä½¿ç”¨') || msg === '?' || msg === 'ï¼Ÿ') {
                addMessage(`**ä½¿ç”¨æµç¨‹ï¼š**\n\n1. ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ç­‰ï¼‰\n2. ğŸ“ ç¡®è®¤å…¬å¸åç§°å’Œæ—¥æœŸ\n3. ğŸš€ ç‚¹å‡»ã€Œç¡®è®¤ç”Ÿæˆå®¡è®¡åº•ç¨¿ã€æŒ‰é’®`, 'assistant');
                return;
            }
            
            // 3. å…¬å¸åç§°è®¾ç½® - æœ¬åœ°å¤„ç†
            const info = extractCompanyInfo(message);
            if (info) {
                state.companyName = info.company;
                state.auditDate = info.date;
                
                if (state.uploadedFiles.length > 0) {
                    // æœ‰æ–‡ä»¶ï¼Œæ˜¾ç¤ºç¡®è®¤æŒ‰é’®
                    const confirmHtml = `
                        <div class="space-y-3">
                            <div class="font-medium">ğŸ“‹ å·²æ›´æ–°ä¿¡æ¯ï¼š</div>
                            <div class="pl-2 space-y-1">
                                <div>â€¢ å…¬å¸åç§°ï¼š<strong>${state.companyName}</strong></div>
                                <div>â€¢ æˆªæ­¢æ—¥æœŸï¼š<strong>${state.auditDate}</strong></div>
                            </div>
                            <div class="pt-2">
                                <button onclick="window.quickConfirm()" class="w-full px-4 py-2.5 bg-gradient-to-r from-accent-purple to-accent-blue rounded-xl text-white font-medium hover:opacity-90 transition-all flex items-center justify-center gap-2">
                                    <span>ğŸš€</span>
                                    <span>ç¡®è®¤ç”Ÿæˆå®¡è®¡åº•ç¨¿</span>
                                </button>
                            </div>
                        </div>
                    `;
                    addMessageHTML(confirmHtml, 'assistant');
                } else {
                    addMessage(`å·²è®°å½•ï¼š\nâ€¢ å…¬å¸ï¼š${info.company}\nâ€¢ æˆªæ­¢æ—¥æœŸï¼š${info.date}\n\nè¯·ä¸Šä¼ æ–‡ä»¶åå†ç”Ÿæˆåº•ç¨¿ã€‚`, 'assistant');
                }
                return;
            }
            
            // 4. å…¶ä»–æƒ…å†µï¼šè°ƒç”¨ LLM
            processIntentWithLLM(message);
        }
        
        async function processIntentWithLLM(message) {
            // æ˜¾ç¤ºæ€è€ƒçŠ¶æ€
            showTypingIndicator();
            
            try {
                // è°ƒç”¨ LLM æ„å›¾è¯†åˆ« API
                const response = await fetch(`${CONFIG.backendUrl}/api/chat/intent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        context: {
                            uploaded_files: state.uploadedFiles.map(f => f.category || f.name),
                            company_name: state.companyName,
                            audit_date: state.auditDate,
                        }
                    }),
                });
                
                hideTypingIndicator();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('LLM Intent:', data);
                
                // æ›´æ–°çŠ¶æ€
                if (data.company_name) {
                    state.companyName = data.company_name;
                }
                if (data.audit_date) {
                    state.auditDate = data.audit_date;
                }
                
                // æ ¹æ®æ„å›¾æ‰§è¡ŒåŠ¨ä½œ
                switch (data.intent) {
                    case 'start_audit':
                        if (state.uploadedFiles.length === 0) {
                            addMessage('è¯·å…ˆä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ã€åºæ—¶è´¦ç­‰ï¼‰ï¼Œæˆ‘éœ€è¦è¿™äº›æ•°æ®æ¥ç”Ÿæˆåº•ç¨¿ã€‚', 'assistant');
                        } else if (!state.companyName) {
                            addMessage('è¯·æä¾›å…¬å¸åç§°ï¼Œä¾‹å¦‚è¾“å…¥ã€Œè”ä¿¡æ™ºæ“ã€', 'assistant');
                        } else {
                            addMessage(data.response || 'ğŸš€ æ­£åœ¨å¯åŠ¨ OpenCPAi å¼•æ“...', 'assistant');
                            await startAuditPipeline();
                        }
                        break;
                        
                    case 'upload_file':
                        addMessage(data.response || 'è¯·ç‚¹å‡»å·¦ä¸‹è§’é™„ä»¶æŒ‰é’®ä¸Šä¼ æ–‡ä»¶', 'assistant');
                        break;
                        
                    default:
                        // å…¶ä»–æ„å›¾ç›´æ¥æ˜¾ç¤º LLM å›å¤
                        addMessage(data.response, 'assistant');
                }
                
            } catch (error) {
                hideTypingIndicator();
                console.error('Intent API error:', error);
                
                // é™çº§åˆ°æœ¬åœ°å¤„ç†
                processIntentLocal(message);
            }
        }
        
        // æœ¬åœ°æ„å›¾å¤„ç†ï¼ˆLLM è°ƒç”¨å¤±è´¥æ—¶çš„é™çº§æ–¹æ¡ˆï¼‰
        function processIntentLocal(message) {
            const msg = message.toLowerCase();
            
            // æå–å…¬å¸+æ—¥æœŸä¿¡æ¯
            const info = extractCompanyInfo(message);
            if (info) {
                state.companyName = info.company;
                state.auditDate = info.date;
            }
            
            // ç¡®è®¤ç”Ÿæˆ/å¯åŠ¨å¼•æ“æ„å›¾
            if ((msg.includes('ç¡®è®¤') && msg.includes('ç”Ÿæˆ')) || (msg.includes('å¯åŠ¨') && msg.includes('å¼•æ“')) || (msg.includes('å¼€å§‹') && msg.includes('ç”Ÿæˆ'))) {
                if (state.uploadedFiles.length === 0) {
                    addMessage('è¯·å…ˆä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ã€åºæ—¶è´¦ç­‰ï¼‰ï¼Œæˆ‘éœ€è¦è¿™äº›æ•°æ®æ¥ç”Ÿæˆåº•ç¨¿ã€‚', 'assistant');
                    return;
                }
                if (!state.companyName) {
                    addMessage('è¯·æä¾›å…¬å¸åç§°ï¼Œä¾‹å¦‚è¾“å…¥ã€Œè”ä¿¡æ™ºæ“ã€', 'assistant');
                    return;
                }
                startAuditPipeline();
                return;
            }
            
            // è®¾ç½®å…¬å¸ä¿¡æ¯
            if (info) {
                if (state.uploadedFiles.length > 0) {
                    // æœ‰æ–‡ä»¶ï¼Œæ˜¾ç¤ºç¡®è®¤æŒ‰é’®
                    const confirmHtml = `
                        <div class="space-y-3">
                            <div>å·²è®°å½•ï¼š</div>
                            <div class="pl-2 space-y-1">
                                <div>â€¢ å…¬å¸ï¼š<strong>${info.company}</strong></div>
                                <div>â€¢ æˆªæ­¢æ—¥æœŸï¼š<strong>${info.date}</strong></div>
                            </div>
                            <div class="pt-2">
                                <button onclick="window.quickConfirm()" class="w-full px-4 py-2.5 bg-gradient-to-r from-accent-purple to-accent-blue rounded-xl text-white font-medium hover:opacity-90 transition-all flex items-center justify-center gap-2">
                                    <span>ğŸš€</span>
                                    <span>ç¡®è®¤ç”Ÿæˆå®¡è®¡åº•ç¨¿</span>
                                </button>
                            </div>
                        </div>
                    `;
                    addMessageHTML(confirmHtml, 'assistant');
                } else {
                    addMessage(`å·²è®°å½•ï¼š\nâ€¢ å…¬å¸ï¼š${info.company}\nâ€¢ æˆªæ­¢æ—¥æœŸï¼š${info.date}\n\nè¯·ä¸Šä¼ æ–‡ä»¶åå†ç”Ÿæˆåº•ç¨¿ã€‚`, 'assistant');
                }
                return;
            }
            
            // å¸®åŠ©
            if (msg.includes('å¦‚ä½•') || msg.includes('å¸®åŠ©') || msg.includes('ä½¿ç”¨')) {
                addMessage(`**ä½¿ç”¨æµç¨‹ï¼š**\n\n1. ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ç­‰ï¼‰\n2. ğŸ“ ç¡®è®¤å…¬å¸åç§°å’Œæ—¥æœŸ\n3. ğŸš€ ç‚¹å‡»ã€Œç¡®è®¤ç”Ÿæˆå®¡è®¡åº•ç¨¿ã€æŒ‰é’®`, 'assistant');
                return;
            }
            
            // é»˜è®¤å›å¤
            addMessage('æˆ‘æ˜¯ Jennyï¼ŒOpenCPAi æ™ºèƒ½è¾…åŠ©åŠ©æ‰‹ã€‚ä½ å¯ä»¥ï¼š\n\nâ€¢ ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ï¼ˆç§‘ç›®ä½™é¢è¡¨ç­‰ï¼‰\nâ€¢ ğŸ“ ç¡®è®¤å…¬å¸ä¿¡æ¯\nâ€¢ ğŸš€ ç‚¹å‡»ã€Œç¡®è®¤ç”Ÿæˆå®¡è®¡åº•ç¨¿ã€æŒ‰é’®', 'assistant');
        }
        
        // æ€è€ƒçŠ¶æ€æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'message-fade-in flex gap-3';
            indicator.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>
                <div class="bg-white/5 rounded-2xl rounded-tl-sm px-4 py-3 flex items-center gap-1">
                    <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                    <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                    <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                </div>
            `;
            $messagesContainer.appendChild(indicator);
            scrollToBottom();
        }
        
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }
        
        // =====================================================
        // æ–‡ä»¶ä¸Šä¼ 
        // =====================================================
        async function handleFileSelect(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            showChatMode();
            
            // æ˜¾ç¤ºå¸¦è¿›åº¦çš„ä¸Šä¼ çŠ¶æ€å¡ç‰‡
            const uploadCardId = 'upload-progress-card';
            const uploadCardHtml = `
                <div id="${uploadCardId}" class="space-y-3">
                    <div class="font-medium">ğŸ“¤ æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...</div>
                    <div id="upload-file-list" class="space-y-2"></div>
                </div>
            `;
            addMessageHTML(uploadCardHtml, 'assistant');
            
            // æ”¶é›†æ‰€æœ‰æ–‡ä»¶çš„åˆ†ç±»ç»“æœ
            const classifiedFiles = {
                balance: null,      // ç§‘ç›®ä½™é¢è¡¨
                journal: null,      // åºæ—¶è´¦
                statement: [],      // è´¢åŠ¡æŠ¥è¡¨ï¼ˆå¯èƒ½å¤šä¸ªï¼‰
                prior_report: null, // ä¸Šå¹´å®¡è®¡æŠ¥å‘Š
            };
            
            const $fileList = document.getElementById('upload-file-list');
            let fileIndex = 0;
            
            for (const file of files) {
                fileIndex++;
                const fileItemId = `upload-file-${fileIndex}`;
                const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                
                // æ·»åŠ è¯¥æ–‡ä»¶çš„è¿›åº¦è¡Œ
                const fileItemHtml = `
                    <div id="${fileItemId}" class="bg-white/5 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm truncate flex-1" title="${file.name}">ğŸ“„ ${fileIndex}ã€${file.name}</span>
                            <span id="${fileItemId}-status" class="text-xs text-gray-400">${fileSizeMB}MB</span>
                        </div>
                        <div class="h-1.5 bg-white/10 rounded-full overflow-hidden">
                            <div id="${fileItemId}-bar" class="h-full bg-gradient-to-r from-accent-purple to-accent-blue rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                `;
                $fileList.insertAdjacentHTML('beforeend', fileItemHtml);
                scrollToBottom();
                
                try {
                    const result = await uploadFileWithProgress(file, fileItemId);
                    
                    if (result.task_id) {
                        state.taskId = result.task_id;
                    }
                    
                    if (result.files && result.files.length > 0) {
                        result.files.forEach(f => {
                            state.uploadedFiles.push({
                                name: f.filename,
                                category: f.category,
                                category_cn: f.category_cn || f.category,
                            });
                            
                            // æŒ‰ç±»å‹å½’ç±»ï¼ˆä¸ Web App ä¿æŒä¸€è‡´ï¼‰
                            // åç«¯è¿”å›: balance, journal, financial, statement, balance_sheet, profit_statement, audit_report, prior_report
                            if (f.category === 'balance') {
                                classifiedFiles.balance = f.filename;
                            } else if (f.category === 'journal') {
                                classifiedFiles.journal = f.filename;
                            } else if (f.category === 'financial' || f.category === 'statement' || f.category === 'balance_sheet' || f.category === 'profit_statement') {
                                classifiedFiles.statement.push(f.filename);
                            } else if (f.category === 'audit_report' || f.category === 'prior_report' || f.category === 'audit') {
                                classifiedFiles.prior_report = f.filename;
                            }
                        });
                    } else {
                        state.uploadedFiles.push({ name: file.name, category: 'unknown' });
                    }
                } catch (error) {
                    addMessage(`âŒ ä¸Šä¼ å¤±è´¥ï¼š${file.name} - ${error.message}`, 'assistant');
                }
            }
            
            // æ˜¾ç¤º Web é£æ ¼çš„æ–‡ä»¶åˆ†ç±»å¡ç‰‡
            if (state.uploadedFiles.length > 0) {
                showFileCardsUI(classifiedFiles);
            }
            
            updateUploadedFilesUI();
            $fileInput.value = '';
        }
        
        // æ˜¾ç¤º Web é£æ ¼çš„æ–‡ä»¶åˆ†ç±»å¡ç‰‡ï¼ˆä¸ Web ä¸€è‡´ï¼šä¸Šä¼ åªæ˜¾ç¤ºåˆ†ç±»ï¼Œä¸è¯†åˆ«å…¬å¸åç§°ï¼‰
        function showFileCardsUI(classifiedFiles) {
            const hasBalance = classifiedFiles.balance !== null;
            
            const html = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="font-medium">ğŸ“ å·²è¯†åˆ«æ–‡ä»¶</div>
                        <span class="text-xs text-gray-400">å…± ${state.uploadedFiles.length} ä¸ª</span>
                    </div>
                    
                    <!-- æ–‡ä»¶åˆ†ç±»å¡ç‰‡ï¼ˆ2x2 ç½‘æ ¼ï¼Œé€‚åˆèŠå¤©çª—å£å®½åº¦ï¼‰-->
                    <div class="grid grid-cols-2 gap-3">
                        ${renderFileCard('ç§‘ç›®ä½™é¢è¡¨', classifiedFiles.balance ? [classifiedFiles.balance] : null, 'required', '#3B82F6')}
                        ${renderFileCard('åºæ—¶è´¦', classifiedFiles.journal ? [classifiedFiles.journal] : null, 'optional', '#10B981')}
                        ${renderFileCard('è´¢åŠ¡æŠ¥è¡¨', classifiedFiles.statement.length > 0 ? classifiedFiles.statement : null, 'optional', '#8B5CF6')}
                        ${renderFileCard('ä¸Šå¹´å®¡è®¡æŠ¥å‘Š', classifiedFiles.prior_report ? [classifiedFiles.prior_report] : null, 'optional', '#F59E0B')}
                    </div>
                    
                    <!-- å¯åŠ¨æŒ‰é’®ï¼ˆä¸Webä¸€è‡´ï¼šå…¬å¸åç§°ç”±åç«¯åœ¨å¤„ç†æ—¶è¯†åˆ«ï¼‰-->
                    ${hasBalance ? `
                        <button onclick="window.quickConfirm()" class="w-full px-4 py-3 bg-gradient-to-r from-accent-purple to-accent-blue rounded-xl text-white font-medium hover:opacity-90 transition-all flex items-center justify-center gap-2">
                            <span>ğŸš€</span>
                            <span>å¯åŠ¨ OpenCPAi å¼•æ“ç”Ÿæˆåº•ç¨¿</span>
                        </button>
                        <div class="text-xs text-gray-400 text-center">å…¬å¸åç§°å’Œå®¡è®¡æˆªæ­¢æ—¥å°†åœ¨å¤„ç†æ—¶è‡ªåŠ¨è¯†åˆ«</div>
                    ` : `
                        <div class="text-center text-yellow-400 text-sm">âš ï¸ è¯·å…ˆä¸Šä¼ ç§‘ç›®ä½™é¢è¡¨ï¼ˆå¿…å¡«ï¼‰</div>
                    `}
                </div>
            `;
            addMessageHTML(html, 'assistant');
        }
        
        // æ¸²æŸ“å•ä¸ªæ–‡ä»¶å¡ç‰‡ï¼ˆæ”¾å¤§ç‰ˆï¼Œæ›´æ¸…æ™°ï¼‰
        // fileName ç°åœ¨æ˜¯æ•°ç»„æ ¼å¼ï¼Œæ”¯æŒå¤šä¸ªæ–‡ä»¶
        function renderFileCard(category, fileNames, type, color) {
            const isRequired = type === 'required';
            const hasFile = fileNames !== null && fileNames.length > 0;
            
            // å›¾æ ‡æ˜ å°„
            const icons = {
                'ç§‘ç›®ä½™é¢è¡¨': 'ğŸ“Š',
                'åºæ—¶è´¦': 'ğŸ“',
                'è´¢åŠ¡æŠ¥è¡¨': 'ğŸ“ˆ',
                'ä¸Šå¹´å®¡è®¡æŠ¥å‘Š': 'ğŸ“‹'
            };
            const icon = icons[category] || 'ğŸ“„';
            
            if (hasFile) {
                // æ¯ä¸ªæ–‡ä»¶å•ç‹¬ä¸€è¡Œæ˜¾ç¤ºï¼ˆä¸æˆªæ–­ï¼Œè‡ªåŠ¨æ¢è¡Œï¼‰
                const fileListHtml = fileNames.map((name, idx) => 
                    `<div class="text-sm text-gray-200 font-medium break-all leading-relaxed">âœ“ ${idx + 1}ã€${name}</div>`
                ).join('');
                
                return `
                    <div class="rounded-xl p-4 border-2" style="border-color: ${color}60; background: ${color}15">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-lg">${icon}</span>
                            <span class="text-sm font-semibold" style="color: ${color}">${category}</span>
                            ${isRequired ? '<span class="text-xs bg-red-500/30 text-red-300 px-2 py-0.5 rounded-full font-medium">å¿…å¡«</span>' : '<span class="text-xs text-gray-400">å¯é€‰</span>'}
                        </div>
                        <div class="space-y-1">${fileListHtml}</div>
                    </div>
                `;
            } else {
                return `
                    <div class="rounded-xl p-4 border-2 border-dashed border-gray-500 bg-white/5">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-lg opacity-40">${icon}</span>
                            <span class="text-sm text-gray-400">${category}</span>
                            ${isRequired ? '<span class="text-xs bg-red-500/30 text-red-300 px-2 py-0.5 rounded-full font-medium">å¿…å¡«</span>' : '<span class="text-xs text-gray-500">å¯é€‰</span>'}
                        </div>
                        <div class="text-sm text-gray-500">æœªä¸Šä¼ </div>
                    </div>
                `;
            }
        }
        
        // å¿«é€Ÿè¯†åˆ«å…¬å¸ä¿¡æ¯ï¼ˆPython ä¼˜å…ˆï¼ŒLLM å¤‡ç”¨ï¼‰
        async function detectCompanyInfoFast() {
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/detect-company-name`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        task_id: state.taskId,
                        fast_mode: true  // å‘Šè¯‰åç«¯ä¼˜å…ˆç”¨ Python
                    }),
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('Detected company info:', data);
                
                // ä¿å­˜ç»“æœ
                if (data.detected_name && data.detected_name !== 'æœªçŸ¥å…¬å¸') {
                    state.companyName = data.detected_name;
                }
                state.auditDate = data.detected_audit_date || '2025/12/31';
                
                // æ›´æ–° UI
                updateCompanyInfoUI(data);
                
            } catch (error) {
                console.error('Detect company error:', error);
                // å¤±è´¥æ—¶æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥æç¤º
                updateCompanyInfoUI({ detected_name: null, detected_audit_date: '2025/12/31' });
            }
        }
        
        // æ›´æ–°å…¬å¸ä¿¡æ¯å±•ç¤º UI
        function updateCompanyInfoUI(data) {
            const $area = document.getElementById('company-info-area');
            if (!$area) return;
            
            if (data.detected_name && data.detected_name !== 'æœªçŸ¥å…¬å¸') {
                $area.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center gap-2">
                            <span class="text-green-400">âœ“</span>
                            <span class="text-sm">å·²è¯†åˆ«å…¬å¸ä¿¡æ¯</span>
                        </div>
                        <div class="bg-white/5 rounded-lg p-3 space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-400 text-sm">å…¬å¸åç§°</span>
                                <span class="text-white text-sm font-medium">${data.detected_name}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400 text-sm">å®¡è®¡æˆªæ­¢æ—¥</span>
                                <span class="text-white text-sm font-medium">${data.detected_audit_date || '2025/12/31'}</span>
                            </div>
                        </div>
                        <button onclick="window.quickConfirm()" class="w-full px-4 py-2.5 bg-gradient-to-r from-accent-purple to-accent-blue rounded-xl text-white font-medium hover:opacity-90 transition-all flex items-center justify-center gap-2">
                            <span>ğŸš€</span>
                            <span>å¯åŠ¨ OpenCPAi å¼•æ“ç”Ÿæˆåº•ç¨¿</span>
                        </button>
                        <div class="text-xs text-gray-500 text-center">ä¿¡æ¯æœ‰è¯¯ï¼Ÿç›´æ¥åœ¨ä¸‹æ–¹è¾“å…¥æ­£ç¡®å†…å®¹</div>
                    </div>
                `;
            } else {
                $area.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center gap-2">
                            <span class="text-yellow-400">âš ï¸</span>
                            <span class="text-sm">æœªèƒ½è‡ªåŠ¨è¯†åˆ«å…¬å¸åç§°</span>
                        </div>
                        <div class="text-xs text-gray-400">è¯·åœ¨ä¸‹æ–¹è¾“å…¥å…¬å¸åç§°ï¼Œä¾‹å¦‚ï¼š<strong>æ·±åœ³è”å…´æœ‰é™å…¬å¸</strong></div>
                    </div>
                `;
            }
        }
        
        // è‡ªåŠ¨æ£€æµ‹å…¬å¸åç§°å’Œå®¡è®¡æˆªæ­¢æ—¥
        async function detectCompanyInfo() {
            try {
                addMessage('ğŸ” æ­£åœ¨è¯†åˆ«å…¬å¸ä¿¡æ¯...', 'assistant');
                
                const response = await fetch(`${CONFIG.backendUrl}/api/detect-company-name`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: state.taskId }),
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Detected company info:', data);
                
                // ä¿å­˜æ£€æµ‹ç»“æœ
                if (data.detected_name && data.detected_name !== 'æœªçŸ¥å…¬å¸') {
                    state.companyName = data.detected_name;
                }
                
                // å®¡è®¡æˆªæ­¢æ—¥ï¼šå¦‚æœæ£€æµ‹åˆ°å°±ç”¨ï¼Œå¦åˆ™é»˜è®¤ 2025/12/31
                if (data.detected_audit_date) {
                    state.auditDate = data.detected_audit_date;
                } else {
                    state.auditDate = '2025/12/31';
                }
                
                // æ˜¾ç¤ºæ£€æµ‹ç»“æœï¼Œè®©ç”¨æˆ·ç¡®è®¤ï¼ˆå¸¦å¿«æ·æŒ‰é’®ï¼‰
                if (state.companyName) {
                    const confirmHtml = `
                        <div class="space-y-3">
                            <div class="font-medium">ğŸ“‹ å·²è¯†åˆ«ä¿¡æ¯ï¼š</div>
                            <div class="pl-2 space-y-1">
                                <div>â€¢ å…¬å¸åç§°ï¼š<strong>${state.companyName}</strong></div>
                                <div>â€¢ æˆªæ­¢æ—¥æœŸï¼š<strong>${state.auditDate}</strong></div>
                            </div>
                            <div class="pt-2 space-y-2">
                                <button onclick="window.quickConfirm()" class="w-full px-4 py-2.5 bg-gradient-to-r from-accent-purple to-accent-blue rounded-xl text-white font-medium hover:opacity-90 transition-all flex items-center justify-center gap-2">
                                    <span>ğŸš€</span>
                                    <span>ç¡®è®¤ç”Ÿæˆå®¡è®¡åº•ç¨¿</span>
                                </button>
                                <div class="text-xs text-gray-400 text-center">æˆ–è¾“å…¥æ­£ç¡®ä¿¡æ¯è¿›è¡Œä¿®æ”¹</div>
                            </div>
                        </div>
                    `;
                    addMessageHTML(confirmHtml, 'assistant');
                } else {
                    // æ— æ³•è¯†åˆ«å…¬å¸åç§°ï¼Œè¯·ç”¨æˆ·è¾“å…¥ï¼ˆå¸¦è¾“å…¥æç¤ºï¼‰
                    state.auditDate = '2025/12/31';
                    const inputHtml = `
                        <div class="space-y-3">
                            <div>ğŸ“‹ å·²ä¸Šä¼  <strong>${state.uploadedFiles.length}</strong> ä¸ªæ–‡ä»¶</div>
                            <div class="text-yellow-400">âš ï¸ æœªèƒ½è‡ªåŠ¨è¯†åˆ«å…¬å¸åç§°</div>
                            <div>è¯·åœ¨ä¸‹æ–¹è¾“å…¥å…¬å¸åç§°ï¼Œä¾‹å¦‚ï¼š<strong>æ·±åœ³è”å…´</strong></div>
                        </div>
                    `;
                    addMessageHTML(inputHtml, 'assistant');
                }
                
            } catch (error) {
                console.error('Detect company error:', error);
                // æ£€æµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
                state.auditDate = '2025/12/31';
                addMessage(`å·²ä¸Šä¼  ${state.uploadedFiles.length} ä¸ªæ–‡ä»¶ã€‚\n\nè¯·è¾“å…¥å…¬å¸åç§°ï¼Œä¾‹å¦‚ã€Œè”ä¿¡æ™ºæ“ã€ï¼Œç„¶åè¯´ã€Œ**ç¡®è®¤ç”Ÿæˆ**ã€å¯åŠ¨å¼•æ“ã€‚`, 'assistant');
            }
        }
        
        // å¸¦è¿›åº¦çš„æ–‡ä»¶ä¸Šä¼ ï¼ˆä½¿ç”¨XMLHttpRequestæ”¯æŒprogressäº‹ä»¶ï¼‰
        function uploadFileWithProgress(file, fileItemId) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const formData = new FormData();
                formData.append('file', file);
                
                // å¦‚æœå·²æœ‰task_idï¼Œä¼ é€’å®ƒä»¥ä¾¿è¿½åŠ æ–‡ä»¶åˆ°åŒä¸€ä¸ªä»»åŠ¡
                if (state.taskId) {
                    formData.append('task_id', state.taskId);
                }
                
                const $bar = document.getElementById(`${fileItemId}-bar`);
                const $status = document.getElementById(`${fileItemId}-status`);
                
                // ä¸Šä¼ è¿›åº¦
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        if ($bar) $bar.style.width = `${percent}%`;
                        if ($status) $status.textContent = `${percent}%`;
                    }
                };
                
                // ä¸Šä¼ å®Œæˆ
                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        if ($bar) $bar.style.width = '100%';
                        if ($status) {
                            $status.textContent = 'âœ“ å®Œæˆ';
                            $status.className = 'text-xs text-green-400';
                        }
                        try {
                            resolve(JSON.parse(xhr.responseText));
                        } catch (e) {
                            reject(new Error('è§£æå“åº”å¤±è´¥'));
                        }
                    } else {
                        if ($status) {
                            $status.textContent = 'âœ— å¤±è´¥';
                            $status.className = 'text-xs text-red-400';
                        }
                        reject(new Error(`HTTP ${xhr.status}`));
                    }
                };
                
                // ä¸Šä¼ é”™è¯¯
                xhr.onerror = () => {
                    if ($status) {
                        $status.textContent = 'âœ— ç½‘ç»œé”™è¯¯';
                        $status.className = 'text-xs text-red-400';
                    }
                    reject(new Error('ç½‘ç»œé”™è¯¯'));
                };
                
                xhr.open('POST', `${CONFIG.backendUrl}/api/upload-and-unpack`);
                xhr.send(formData);
            });
        }
        
        // åŸå§‹ä¸Šä¼ å‡½æ•°ï¼ˆä¿ç•™ç”¨äºå…¶ä»–åœºæ™¯ï¼‰
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            // å¦‚æœå·²æœ‰task_idï¼Œä¼ é€’å®ƒä»¥ä¾¿è¿½åŠ æ–‡ä»¶åˆ°åŒä¸€ä¸ªä»»åŠ¡
            if (state.taskId) {
                formData.append('task_id', state.taskId);
            }
            
            const response = await fetch(`${CONFIG.backendUrl}/api/upload-and-unpack`, {
                method: 'POST',
                body: formData,
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            return await response.json();
        }
        
        function updateUploadedFilesUI() {
            if (state.uploadedFiles.length === 0) {
                $uploadedFiles.classList.add('hidden');
                return;
            }
            
            // ç±»åˆ«é¢œè‰²å’Œå›¾æ ‡æ˜ å°„
            const categoryStyles = {
                'balance': { label: 'ç§‘ç›®ä½™é¢è¡¨', color: '#3B82F6', icon: 'ğŸ“Š' },
                'journal': { label: 'åºæ—¶è´¦', color: '#10B981', icon: 'ğŸ“' },
                'profit_statement': { label: 'åˆ©æ¶¦è¡¨', color: '#8B5CF6', icon: 'ğŸ“ˆ' },
                'balance_sheet': { label: 'èµ„äº§è´Ÿå€ºè¡¨', color: '#8B5CF6', icon: 'ğŸ“ˆ' },
                'statement': { label: 'è´¢åŠ¡æŠ¥è¡¨', color: '#8B5CF6', icon: 'ğŸ“ˆ' },
                'financial': { label: 'è´¢åŠ¡æŠ¥è¡¨', color: '#8B5CF6', icon: 'ğŸ“ˆ' },
                'audit_report': { label: 'ä¸Šå¹´å®¡è®¡æŠ¥å‘Š', color: '#F59E0B', icon: 'ğŸ“‹' },
                'prior_report': { label: 'ä¸Šå¹´å®¡è®¡æŠ¥å‘Š', color: '#F59E0B', icon: 'ğŸ“‹' },
                'pdf': { label: 'PDFæ–‡æ¡£', color: '#EF4444', icon: 'ğŸ“„' },
                'excel': { label: 'Excelæ–‡ä»¶', color: '#22C55E', icon: 'ğŸ“„' },
            };
            
            $uploadedFiles.classList.remove('hidden');
            $uploadedFiles.innerHTML = state.uploadedFiles.map((f, i) => {
                const style = categoryStyles[f.category] || { label: f.category_cn || f.category || 'æ–‡ä»¶', color: '#6B7280', icon: 'ğŸ“„' };
                return `
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm" style="background: ${style.color}20; border: 1px solid ${style.color}50">
                        <span>${style.icon}</span>
                        <span style="color: ${style.color}">${style.label}</span>
                        <button onclick="removeFile(${i})" class="text-gray-400 hover:text-white ml-1">Ã—</button>
                    </div>
                `;
            }).join('');
        }
        
        window.removeFile = function(index) {
            state.uploadedFiles.splice(index, 1);
            updateUploadedFilesUI();
        };
        
        // =====================================================
        // å®¡è®¡ä»»åŠ¡
        // =====================================================
        async function startAuditPipeline() {
            if (!state.taskId) {
                addMessage('è¯·å…ˆä¸Šä¼ æ–‡ä»¶ã€‚', 'assistant');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç§‘ç›®ä½™é¢è¡¨ï¼ˆå¿…å¡«ï¼‰
            const hasBalance = state.uploadedFiles.some(f => f.category === 'balance');
            if (!hasBalance) {
                addMessage('âš ï¸ è¯·å…ˆä¸Šä¼ ç§‘ç›®ä½™é¢è¡¨ï¼ˆå¿…å¡«ï¼‰', 'assistant');
                return;
            }
            
            state.isProcessing = true;
            state.startTime = Date.now();
            
            // æ˜¾ç¤ºè¿›åº¦å¡ç‰‡
            showProgressCard();
            
            try {
                // â­ ä¸ Web æ¨¡å¼ä¸€è‡´ï¼šå…¬å¸åç§°ç”±åç«¯è‡ªåŠ¨è¯†åˆ«
                const response = await fetch(`${CONFIG.backendUrl}/api/run-full-pipeline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: 'upload',
                        task_id: state.taskId,
                        company_name: state.companyName || '',  // è®©åç«¯è‡ªåŠ¨è¯†åˆ«
                        audit_end_date: state.auditDate || '2024/12/31',
                    }),
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }
                
                // å¼€å§‹è½®è¯¢çŠ¶æ€
                startTimer();
                pollTaskStatus();
                
            } catch (error) {
                hideProgressCard();
                addMessage(`âŒ å¯åŠ¨å¤±è´¥ï¼š${error.message}`, 'assistant');
                state.isProcessing = false;
            }
        }
        
        // æ˜¾ç¤ºè¿›åº¦å¡ç‰‡
        function showProgressCard() {
            const cardHtml = `
            <div id="progress-card" class="message-fade-in flex gap-3">
                <div class="flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>
                    <span class="text-xs text-gray-500">Jenny</span>
                </div>
                <div class="flex-1 max-w-4xl bg-white/5 rounded-2xl rounded-tl-sm p-4">
                    <!-- æ ‡é¢˜å’Œè®¡æ—¶å™¨ -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-base font-medium">ğŸš€ OpenCPAi å¼•æ“æ­£åœ¨ä¸ºã€Œ${state.companyName}ã€ç”Ÿæˆåº•ç¨¿</span>
                        </div>
                        <div class="flex items-center gap-2 bg-black/30 px-3 py-1.5 rounded-lg">
                            <div id="timer-dot" class="w-2 h-2 bg-green-500 rounded-full timer-pulse"></div>
                            <span id="timer-display" class="font-mono text-sm text-green-400">00:00.00</span>
                        </div>
                    </div>
                    
                    <!-- è¿›åº¦æ¡å’Œç™¾åˆ†æ¯” -->
                    <div class="mb-4">
                        <div class="flex justify-between text-xs mb-1">
                            <span id="progress-percent" class="text-blue-400 font-medium">5%</span>
                            <span id="progress-eta" class="text-gray-400">é¢„è®¡çº¦ 2 åˆ†é’Ÿ</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="progress-bar" class="progress-bar h-2.5 rounded-full" style="width: 5%"></div>
                        </div>
                    </div>
                    
                    <!-- æ­¥éª¤åˆ—è¡¨ -->
                    <div id="steps-list" class="grid grid-cols-5 gap-2 text-xs text-center mb-4">
                        <div class="step-item" data-step="1">
                            <div class="w-6 h-6 mx-auto mb-1 rounded-full bg-blue-500 flex items-center justify-center step-running">1</div>
                            <span>æ–‡ä»¶è§£æ</span>
                        </div>
                        <div class="step-item" data-step="2">
                            <div class="w-6 h-6 mx-auto mb-1 rounded-full bg-gray-600 flex items-center justify-center">2</div>
                            <span class="text-gray-500">æ™ºèƒ½æ¸…æ´—</span>
                        </div>
                        <div class="step-item" data-step="3">
                            <div class="w-6 h-6 mx-auto mb-1 rounded-full bg-gray-600 flex items-center justify-center">3</div>
                            <span class="text-gray-500">ç”Ÿæˆåº•ç¨¿</span>
                        </div>
                        <div class="step-item" data-step="4">
                            <div class="w-6 h-6 mx-auto mb-1 rounded-full bg-gray-600 flex items-center justify-center">4</div>
                            <span class="text-gray-500">æŠ¥å‘Šç”Ÿæˆ</span>
                        </div>
                        <div class="step-item" data-step="5">
                            <div class="w-6 h-6 mx-auto mb-1 rounded-full bg-gray-600 flex items-center justify-center">5</div>
                            <span class="text-gray-500">å®Œæˆ</span>
                        </div>
                    </div>
                    
                    <!-- ç»ˆç«¯æ—¥å¿— -->
                    <div class="log-window">
                        <div class="flex items-center gap-2 px-3 py-2 border-b border-gray-700">
                            <div class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
                            <span class="text-gray-400 text-xs ml-2">OpenCPAi Engine Console</span>
                        </div>
                        <div id="log-content" class="p-3 h-32 overflow-y-auto space-y-1">
                            <div class="log-line info">âœ åˆå§‹åŒ– OpenCPAi å¼•æ“...</div>
                            <div class="log-line">ğŸ“‚ åŠ è½½å®¡è®¡æ–‡ä»¶...</div>
                        </div>
                    </div>
                </div>
            </div>`;
            
            $messagesContainer.insertAdjacentHTML('beforeend', cardHtml);
            scrollToBottom();
        }
        
        function hideProgressCard() {
            const card = document.getElementById('progress-card');
            if (card) card.remove();
            stopTimer();
        }
        
        // è®¡æ—¶å™¨ - æ˜¾ç¤ºæ ¼å¼ 00:00.00 (åˆ†:ç§’.å˜ç§’)
        let timerStartMs = 0;
        function startTimer() {
            timerStartMs = Date.now();
            state.timerInterval = setInterval(() => {
                const elapsedMs = Date.now() - timerStartMs;
                const totalSeconds = Math.floor(elapsedMs / 1000);
                const mins = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const secs = (totalSeconds % 60).toString().padStart(2, '0');
                const centisecs = Math.floor((elapsedMs % 1000) / 10).toString().padStart(2, '0');
                
                const display = document.getElementById('timer-display');
                if (display) display.textContent = `${mins}:${secs}.${centisecs}`;
                
                // æ›´æ–°é¢„ä¼°å‰©ä½™æ—¶é—´
                updateETA(totalSeconds);
            }, 50); // 50msæ›´æ–°ä¸€æ¬¡ï¼Œè®©å˜ç§’æµç•…
        }
        
        // æ›´æ–°é¢„ä¼°å‰©ä½™æ—¶é—´
        function updateETA(elapsed) {
            const eta = document.getElementById('progress-eta');
            if (!eta) return;
            
            const totalEstimate = 120; // é¢„ä¼°æ€»æ—¶é•´2åˆ†é’Ÿ
            const remaining = Math.max(0, totalEstimate - elapsed);
            
            if (remaining > 60) {
                const mins = Math.ceil(remaining / 60);
                eta.textContent = `é¢„è®¡å‰©ä½™ ${mins} åˆ†é’Ÿ`;
            } else if (remaining > 0) {
                eta.textContent = `é¢„è®¡å‰©ä½™ ${remaining} ç§’`;
            } else {
                eta.textContent = `å³å°†å®Œæˆ...`;
            }
        }
        
        function stopTimer() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        }
        
        // æ›´æ–°è¿›åº¦
        function updateProgress(step, progress, logMessage) {
            // æ›´æ–°è¿›åº¦æ¡
            const bar = document.getElementById('progress-bar');
            if (bar) bar.style.width = `${progress}%`;
            
            // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
            const percent = document.getElementById('progress-percent');
            if (percent) percent.textContent = `${progress}%`;
            
            // æ›´æ–°æ­¥éª¤
            const stepMapping = { 'upload': 1, 'clean': 2, 'km': 3, 'allocate': 4, 'complete': 5 };
            const currentStep = stepMapping[step] || 1;
            
            document.querySelectorAll('.step-item').forEach((item, i) => {
                const stepNum = i + 1;
                const circle = item.querySelector('div');
                const text = item.querySelector('span');
                
                if (stepNum < currentStep) {
                    circle.className = 'w-6 h-6 mx-auto mb-1 rounded-full bg-green-500 flex items-center justify-center';
                    circle.innerHTML = 'âœ“';
                    text.className = 'text-green-400';
                } else if (stepNum === currentStep) {
                    circle.className = 'w-6 h-6 mx-auto mb-1 rounded-full bg-blue-500 flex items-center justify-center step-running';
                    text.className = 'text-blue-400';
                } else {
                    circle.className = 'w-6 h-6 mx-auto mb-1 rounded-full bg-gray-600 flex items-center justify-center';
                    text.className = 'text-gray-500';
                }
            });
            
            // æ·»åŠ æ—¥å¿—
            if (logMessage) {
                addLogLine(logMessage);
            }
        }
        
        function addLogLine(message, type = 'info') {
            const logContent = document.getElementById('log-content');
            if (!logContent) return;
            
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = message;
            logContent.appendChild(line);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        async function pollTaskStatus() {
            if (!state.taskId) return;
            
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/status/${state.taskId}`);
                const data = await response.json();
                
                // æ ¹æ®çŠ¶æ€æ›´æ–°è¿›åº¦
                if (data.current_step) {
                    const stepProgress = {
                        'upload': 15,
                        'clean': 35,
                        'km': 55,
                        'allocate': 75,
                        'report': 90,
                        'complete': 100
                    };
                    const progress = stepProgress[data.current_step] || 20;
                    updateProgress(data.current_step, progress, data.log_message);
                }
                
                if (data.status === 'completed') {
                    state.isProcessing = false;
                    updateProgress('complete', 100, 'âœ… ä»»åŠ¡å®Œæˆï¼');
                    hideProgressCard();
                    showCompletedResult(data);
                } else if (data.status === 'failed') {
                    state.isProcessing = false;
                    hideProgressCard();
                    addMessage(`âŒ ä»»åŠ¡å¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'assistant');
                } else {
                    // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
                    simulateProgress();
                    // ç»§ç»­è½®è¯¢
                    setTimeout(pollTaskStatus, CONFIG.pollInterval);
                }
            } catch (error) {
                setTimeout(pollTaskStatus, CONFIG.pollInterval);
            }
        }
        
        // æ¨¡æ‹Ÿè¿›åº¦ï¼ˆå½“åç«¯æ²¡æœ‰è¿”å›è¯¦ç»†æ­¥éª¤æ—¶ï¼‰
        // æŒ‰120ç§’è®¾è®¡ï¼Œé˜²æ­¢æå‰åˆ°100%
        let simulatedStep = 1;
        const TOTAL_ESTIMATE_SECONDS = 120; // é¢„ä¼°æ€»æ—¶é—´2åˆ†é’Ÿ
        
        function simulateProgress() {
            const elapsed = (Date.now() - state.startTime) / 1000;
            // è®¡ç®—ç™¾åˆ†æ¯”ï¼Œæœ€å¤šåˆ°95%ï¼ˆç•™ç»™å®Œæˆæ—¶åˆ°4ï¼‰
            const progressPercent = Math.min(95, Math.round((elapsed / TOTAL_ESTIMATE_SECONDS) * 100));
            
            // æ ¹æ®æ—¶é—´æ›´æ–°æ­¥éª¤å’Œæ—¥å¿—
            if (elapsed >= 5 && elapsed < 20 && simulatedStep < 2) {
                simulatedStep = 2;
                updateProgress('clean', progressPercent, 'ğŸ§¹ å¼€å§‹æ™ºèƒ½æ¸…æ´—...');
                addLogLine('ğŸ“Š è¯†åˆ«ç§‘ç›®ä½™é¢è¡¨æ ¼å¼');
                addLogLine('ğŸ“„ æå–å…¬å¸åç§°...');
            } else if (elapsed >= 20 && elapsed < 45 && simulatedStep < 3) {
                simulatedStep = 3;
                updateProgress('km', progressPercent, 'ğŸ“ ç”ŸæˆKMè¡¨...');
                addLogLine('âœ… æ¸…æ´—å®Œæˆï¼Œå…±è¯†åˆ« 156 ä¸ªç§‘ç›®');
                addLogLine('ğŸ¢ å…¬å¸åç§°: ' + (state.companyName || 'è¯†åˆ«ä¸­...'));
            } else if (elapsed >= 45 && elapsed < 75 && simulatedStep < 4) {
                simulatedStep = 4;
                updateProgress('allocate', progressPercent, 'ğŸ“‹ åˆ†é…å·¥ä½œåº•ç¨¿...');
                addLogLine('ğŸ“‚ æ­£åœ¨å¡«å……åº•ç¨¿æ¨¡æ¿');
            } else if (elapsed >= 75 && simulatedStep < 5) {
                updateProgress('report', progressPercent, 'ğŸ“„ ç”Ÿæˆå®¡è®¡æŠ¥å‘Š...');
                addLogLine('ğŸ“‘ è°ƒç”¨ VBA å®å¤„ç†');
            } else {
                // åªæ›´æ–°è¿›åº¦æ¡ï¼Œä¸æ”¹å˜æ­¥éª¤
                const bar = document.getElementById('progress-bar');
                const percent = document.getElementById('progress-percent');
                if (bar) bar.style.width = `${progressPercent}%`;
                if (percent) percent.textContent = `${progressPercent}%`;
            }
        }
        
        function showCompletedResult(data) {
            const elapsed = state.startTime ? Math.floor((Date.now() - state.startTime) / 1000) : 0;
            const mins = Math.floor(elapsed / 60);
            const secs = (elapsed % 60).toString().padStart(2, '0');
            const timeStr = `${mins.toString().padStart(2, '0')}:${secs}`;
            
            const resultHtml = `
            <div id="result-card" class="message-fade-in flex gap-3">
                <div class="flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>
                    <span class="text-xs text-gray-500">Jenny</span>
                </div>
                <div class="flex-1 max-w-4xl bg-gradient-to-b from-gray-800/50 to-gray-900/50 rounded-2xl rounded-tl-sm p-6 border border-white/10">
                    <!-- æˆåŠŸå›¾æ ‡ -->
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto bg-green-500 rounded-full flex items-center justify-center mb-4 shadow-lg shadow-green-500/30">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold mb-2">ğŸ‰ åº•ç¨¿ç”Ÿæˆå®Œæˆï¼</h3>
                        <p class="text-sm text-gray-400 flex items-center justify-center gap-2">
                            <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                            æ€»è€—æ—¶: ${timeStr}
                        </p>
                    </div>
                    
                    <!-- å››ä¸ªä¸‹è½½å¡ç‰‡ -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <!-- è´¢å®¡åº•ç¨¿ -->
                        <a href="${CONFIG.backendUrl}/api/download-pipeline-file/${state.taskId}/workpaper" target="_blank"
                           class="group flex items-center gap-3 p-4 bg-blue-500/5 hover:bg-blue-500/15 rounded-xl border border-blue-400/20 transition-all">
                            <div class="w-11 h-11 bg-blue-500 rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-sm text-white">è´¢å®¡åº•ç¨¿</p>
                                <p class="text-xs text-blue-400 truncate">ã€è´¢å®¡åº•ç¨¿ã€‘${state.companyName}.xlsm</p>
                            </div>
                            <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center opacity-80 group-hover:opacity-100">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </div>
                        </a>
                        
                        <!-- è´¢å®¡æŠ¥å‘Š -->
                        <a href="${CONFIG.backendUrl}/api/download-pipeline-file/${state.taskId}/audit_report_pdf" target="_blank"
                           class="group flex items-center gap-3 p-4 bg-green-500/5 hover:bg-green-500/15 rounded-xl border border-green-400/20 transition-all">
                            <div class="w-11 h-11 bg-green-500 rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-sm text-white">è´¢å®¡æŠ¥å‘Š</p>
                                <p class="text-xs text-green-400 truncate">ã€è´¢å®¡æŠ¥å‘Šã€‘${state.companyName}.pdf</p>
                            </div>
                            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center opacity-80 group-hover:opacity-100">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </div>
                        </a>
                        
                        <!-- æ£€æŸ¥æŠ¥å‘Š -->
                        <a href="${CONFIG.backendUrl}/api/download-pipeline-file/${state.taskId}/check_report_pdf" target="_blank"
                           class="group flex items-center gap-3 p-4 bg-orange-500/5 hover:bg-orange-500/15 rounded-xl border border-orange-400/20 transition-all">
                            <div class="w-11 h-11 bg-orange-500 rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-sm text-white">æ£€æŸ¥æŠ¥å‘Š</p>
                                <p class="text-xs text-orange-400 truncate">ã€æ£€æŸ¥æŠ¥å‘Šã€‘${state.companyName}.xlsx</p>
                            </div>
                            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center opacity-80 group-hover:opacity-100">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </div>
                        </a>
                        
                        <!-- ç§‘ç›®ä½™é¢è¡¨ -->
                        <a href="${CONFIG.backendUrl}/api/download-pipeline-file/${state.taskId}/balance_cleaned" target="_blank"
                           class="group flex items-center gap-3 p-4 bg-purple-500/5 hover:bg-purple-500/15 rounded-xl border border-purple-400/20 transition-all">
                            <div class="w-11 h-11 bg-purple-500 rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-sm text-white">ç§‘ç›®ä½™é¢è¡¨</p>
                                <p class="text-xs text-purple-400 truncate">ã€ç§‘ç›®ä½™é¢è¡¨ã€‘${state.companyName}.xlsx</p>
                            </div>
                            <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center opacity-80 group-hover:opacity-100">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </div>
                        </a>
                    </div>
                    
                    <!-- åº•éƒ¨æŒ‰é’® -->
                    <div class="flex gap-3 mt-4 justify-center">
                        <button onclick="downloadAllFiles()" class="flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-xl font-medium transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            ğŸ“¦ ä¸€é”®ä¸‹è½½å…¨éƒ¨
                        </button>
                        <button onclick="resetChat()" class="px-6 py-3 bg-white/5 hover:bg-white/10 rounded-xl border border-white/10 font-medium transition-all">
                            + å¤„ç†æ–°æ–‡ä»¶
                        </button>
                    </div>
                </div>
            </div>`;
            
            $messagesContainer.insertAdjacentHTML('beforeend', resultHtml);
            scrollToBottom();
            
            // é‡ç½®æ¨¡æ‹Ÿè¿›åº¦
            simulatedStep = 1;
        }
        
        // ä¸€é”®ä¸‹è½½å…¨éƒ¨æ–‡ä»¶
        function downloadAllFiles() {
            const files = ['workpaper', 'audit_report_pdf', 'check_report_pdf', 'balance_cleaned'];
            files.forEach((file, i) => {
                setTimeout(() => {
                    window.open(`${CONFIG.backendUrl}/api/download-pipeline-file/${state.taskId}/${file}`, '_blank');
                }, i * 500);
            });
        }
        
        // =====================================================
        // æ¼”ç¤ºæ¨¡å¼
        // =====================================================
        async function startDemoMode() {
            showChatMode();
            addMessage('ğŸ¯ å·²è¿›å…¥æ¼”ç¤ºæ¨¡å¼ï¼Œä½¿ç”¨ç¤ºä¾‹å…¬å¸æ•°æ®ï¼Œå¯åŠ¨ OpenCPAi å¼•æ“...', 'assistant');
            
            // è®¾ç½®æ¼”ç¤ºå…¬å¸ä¿¡æ¯
            state.companyName = 'è”ä¿¡æ™ºæ“ï¼ˆæ·±åœ³ï¼‰ç§‘æŠ€æœ‰é™å…¬å¸';
            state.auditDate = '2025/12/31';
            state.isProcessing = true;
            state.startTime = Date.now();
            
            try {
                // è°ƒç”¨åç«¯æ¼”ç¤º API
                const response = await fetch(`${CONFIG.backendUrl}/api/run-full-pipeline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: 'demo',  // ä½¿ç”¨æ¼”ç¤ºæ•°æ®
                        company_name: state.companyName,
                        audit_end_date: state.auditDate,
                    }),
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                state.taskId = data.task_id;
                
                // æ¨¡æ‹Ÿä¸Šä¼ æ–‡ä»¶çŠ¶æ€
                state.uploadedFiles = [
                    { name: 'ç§‘ç›®ä½™é¢è¡¨', category: 'ç§‘ç›®ä½™é¢è¡¨' },
                    { name: 'åºæ—¶è´¦', category: 'åºæ—¶è´¦' },
                ];
                updateUploadedFilesUI();
                
                // æ˜¾ç¤ºè¿›åº¦å¡ç‰‡å¹¶å¼€å§‹è½®è¯¢
                showProgressCard();
                startTimer();
                pollTaskStatus();
                
            } catch (error) {
                addMessage(`âŒ OpenCPAi å¼•æ“å¯åŠ¨å¤±è´¥ï¼š${error.message}\n\nè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚`, 'assistant');
                state.isProcessing = false;
            }
        }
        
        // =====================================================
        // UI è¾…åŠ©
        // =====================================================
        function showChatMode() {
            $welcomeScreen.classList.add('hidden');
            $messagesContainer.classList.remove('hidden');
        }
        
        function resetChat() {
            state.taskId = null;
            state.uploadedFiles = [];
            state.companyName = '';
            state.auditDate = '';
            state.isProcessing = false;
            state.messages = [];
            
            $messagesContainer.innerHTML = '';
            $uploadedFiles.innerHTML = '';
            $uploadedFiles.classList.add('hidden');
            
            $welcomeScreen.classList.remove('hidden');
            $messagesContainer.classList.add('hidden');
        }
        
        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-fade-in flex gap-3 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            // ç”¨æˆ·å¤´åƒï¼šæ˜¾ç¤ºåå­—é¦–å­—
            const userInitial = state.userName ? state.userName.charAt(0) : 'æˆ‘';
            const avatar = role === 'user' 
                ? `<div class="flex flex-col items-center gap-1">
                     <div class="w-8 h-8 rounded-full bg-accent-blue flex items-center justify-center text-sm font-medium">${userInitial}</div>
                     <span class="text-xs text-gray-500">${state.userName}</span>
                   </div>`
                : `<div class="flex flex-col items-center gap-1">
                     <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>
                     <span class="text-xs text-gray-500">Jenny</span>
                   </div>`;
            
            const bubbleClass = role === 'user'
                ? 'bg-accent-blue/20 rounded-2xl rounded-tr-sm'
                : 'bg-white/5 rounded-2xl rounded-tl-sm';
            
            // ç®€å• Markdown è½¬æ¢
            const html = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `
                ${avatar}
                <div class="max-w-3xl ${bubbleClass} px-4 py-3 text-sm leading-relaxed">
                    ${html}
                </div>
            `;
            
            $messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function addMessageHTML(html, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-fade-in flex gap-3 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            messageDiv.innerHTML = `
                <div class="flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-accent-purple to-accent-blue flex items-center justify-center text-sm">âœ¨</div>
                    <span class="text-xs text-gray-500">Jenny</span>
                </div>
                <div class="max-w-3xl bg-white/5 rounded-2xl rounded-tl-sm px-4 py-3 text-sm leading-relaxed">
                    ${html}
                </div>
            `;
            
            $messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function scrollToBottom() {
            $chatMessages.scrollTop = $chatMessages.scrollHeight;
        }
        
        function extractCompanyInfo(message) {
            const datePatterns = [
                /(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/,
                /(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥?)/,
            ];
            
            let date = null;
            let company = message;
            
            // æå–æ—¥æœŸ
            for (const pattern of datePatterns) {
                const match = message.match(pattern);
                if (match) {
                    date = match[1].replace(/[å¹´æœˆ]/g, '-').replace(/æ—¥/g, '');
                    company = message.replace(match[0], '').trim();
                    break;
                }
            }
            
            // æ¸…é™¤å¤šä½™çš„å…³é”®è¯ï¼ˆå¼€å§‹å®¡è®¡ã€ç”Ÿæˆåº•ç¨¿ç­‰ï¼‰
            const removeKeywords = ['å¼€å§‹å®¡è®¡', 'å¼€å§‹', 'å®¡è®¡', 'ç”Ÿæˆåº•ç¨¿', 'ç”Ÿæˆ', 'å¸®æˆ‘', 'è¯·'];
            for (const kw of removeKeywords) {
                company = company.replace(new RegExp(kw, 'g'), '').trim();
            }
            
            // å¦‚æœæœ‰æ—¥æœŸï¼Œè¿”å›ç»“æœ
            if (date && company.length >= 2) {
                return { company, date };
            }
            
            // å¦‚æœæ²¡æœ‰æ—¥æœŸä½†æœ‰å…¬å¸åç‰¹å¾
            if (!date && company.length >= 2 && !company.includes('ï¼Ÿ') && !company.includes('?')) {
                const companyKeywords = ['å…¬å¸', 'æœ‰é™', 'é›†å›¢', 'ç§‘æŠ€', 'æ§è‚¡', 'äº‹åŠ¡æ‰€', 'åˆä¼™'];
                if (companyKeywords.some(k => company.includes(k))) {
                    return { company, date: '2025/12/31' };  // é»˜è®¤ä½¿ç”¨2025å¹´åº•
                }
            }
            
            return null;
        }
    </script>
</body>
</html>
